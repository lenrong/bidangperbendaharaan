<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anggaran Kas Generator - Pembagi Pagu RKA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .app-container {
            max-width: 1800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
            max-width: 800px;
            margin: 0 auto 10px;
        }
        
        .credit {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .content {
            padding: 30px;
        }
        
        .step-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .step-container::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 0;
            right: 0;
            height: 3px;
            background: #e0e0e0;
            z-index: 1;
        }
        
        .step {
            text-align: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            margin: 0 auto 10px;
            transition: all 0.3s;
        }
        
        .step.active .step-circle {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            transform: scale(1.1);
        }
        
        .step.completed .step-circle {
            background: #4CAF50;
            color: white;
        }
        
        .step-label {
            font-size: 14px;
            font-weight: 500;
            color: #666;
        }
        
        .step.active .step-label {
            color: #1a2980;
            font-weight: 600;
        }
        
        .section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #eaeaea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        h2 {
            color: #1a2980;
            font-size: 24px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f4f8;
            font-weight: 600;
        }
        
        h3 {
            color: #26d0ce;
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #1a2980;
            box-shadow: 0 0 0 3px rgba(26, 41, 128, 0.1);
        }
        
        select.form-control {
            background-color: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%231a2980' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 12px;
            padding-right: 40px;
        }
        
        .file-upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            background-color: #fafbfc;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .file-upload-area:hover {
            border-color: #1a2980;
            background-color: #f8fafd;
        }
        
        .file-upload-area.dragover {
            border-color: #26d0ce;
            background-color: #e8f4f4;
        }
        
        .upload-icon {
            font-size: 60px;
            color: #1a2980;
            margin-bottom: 20px;
            opacity: 0.7;
        }
        
        .file-upload-area input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .preview-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        
        .preview-table th {
            background: #f8f9fa;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            color: #1a2980;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
        }
        
        .preview-table td {
            padding: 8px 6px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .preview-table tr:hover {
            background-color: #f8fafd;
        }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #1a2980;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a2980;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .mode-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #eaeaea;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .mode-card:hover {
            border-color: #1a2980;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .mode-card.selected {
            border-color: #1a2980;
            background: linear-gradient(135deg, #f8fafd 0%, #e8f4f4 100%);
        }
        
        .mode-icon {
            font-size: 40px;
            color: #1a2980;
            margin-bottom: 15px;
        }
        
        .mode-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a2980;
            margin-bottom: 10px;
        }
        
        .mode-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        
        .quarter-inputs, .semester-inputs, .custom-month-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .quarter-box, .semester-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #1a2980;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(26, 41, 128, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(46, 125, 50, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-3px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #eaeaea;
            justify-content: center;
        }
        
        .results-section {
            margin-top: 30px;
            display: none;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-top: 4px solid #1a2980;
            transition: transform 0.3s;
        }
        
        .result-card:hover {
            transform: translateY(-5px);
        }
        
        .result-title {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .result-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a2980;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #eaeaea;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            color: #666;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            color: #1a2980;
            background-color: #f8fafd;
        }
        
        .tab-btn.active {
            color: #1a2980;
            border-bottom-color: #1a2980;
            background-color: #f8fafd;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .chart-container {
            height: 400px;
            margin-bottom: 30px;
            position: relative;
        }
        
        .data-table-container {
            max-height: 600px;
            overflow-x: auto;
            overflow-y: auto;
            border: 1px solid #eaeaea;
            border-radius: 8px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #1a2980;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eaeaea;
            white-space: nowrap;
        }
        
        .data-table tr:hover {
            background-color: #f8fafd;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .alert {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid;
        }
        
        .alert-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Tambahan untuk tabel OPD */
        .opd-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }
        
        .opd-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #1a2980;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
        }
        
        .opd-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .opd-table tr:hover {
            background-color: #f8fafd;
        }
        
        .opd-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #e3f2fd;
            color: #1a2980;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Style untuk konfigurasi kelompok */
        .group-config-section {
            margin-top: 30px;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .group-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        
        .group-table th {
            background: #f0f4f8;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #1a2980;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
        }
        
        .group-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eaeaea;
            background: white;
        }
        
        .group-row {
            background: white;
        }
        
        .group-row:hover {
            background: #f8fafd;
        }
        
        .group-name-cell {
            min-width: 250px;
            max-width: 300px;
        }
        
        .month-input {
            width: 70px;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: right;
        }
        
        .month-input:focus {
            outline: none;
            border-color: #1a2980;
            box-shadow: 0 0 0 2px rgba(26, 41, 128, 0.1);
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .step-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .step-container::before {
                display: none;
            }
            
            .step-circle {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>Anggaran Kas Generator</h1>
            <p>Sistem Pembagi Pagu Belanja RKA Berdasarkan Pola Distribusi yang Ditentukan</p>
            <div class="credit">
                Dikembangkan oleh: Hendra, Bidang Perbendaharaan BPKAD Kabupaten Mamuju
            </div>
        </div>
        
        <div class="content">
            <div class="step-container">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Upload RKA</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Review Data</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Konfigurasi</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Preview</div>
                </div>
                <div class="step" id="step5">
                    <div class="step-circle">5</div>
                    <div class="step-label">Hasil</div>
                </div>
            </div>
            
            <!-- Step 1: Upload RKA -->
            <div id="step1-section" class="section">
                <h2>1. Upload File RKA</h2>
                <div class="alert alert-info">
                    <strong>Format file:</strong> Excel (.xlsx, .xls) dengan struktur kolom sebagai berikut:<br>
                    NO, TAHUN, KODE URUSAN, NAMA URUSAN, KODE SKPD, NAMA SKPD, KODE SUB UNIT, NAMA SUB UNIT,<br>
                    KODE BIDANG URUSAN, NAMA BIDANG URUSAN, KODE PROGRAM, NAMA PROGRAM, KODE KEGIATAN,<br>
                    NAMA KEGIATAN, KODE SUB KEGIATAN, NAMA SUB KEGIATAN, KODE SUMBER DANA, NAMA SUMBER DANA,<br>
                    KODE REKENING, NAMA REKENING, PAGU
                </div>
                
                <div class="file-upload-area" id="dropArea">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Klik atau tarik file RKA ke sini</h3>
                    <p>File Excel dengan data anggaran belanja (format APBD/APBDes)</p>
                    <input type="file" id="rkaFile" accept=".xlsx,.xls">
                </div>
                
                <div id="uploadStats" style="display: none;">
                    <h3>Preview Data</h3>
                    <div class="stats-summary">
                        <div class="stat-card">
                            <div class="stat-value" id="totalRows">0</div>
                            <div class="stat-label">Total Baris Data</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalPaguUpload">0</div>
                            <div class="stat-label">Total Pagu</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgPagu">0</div>
                            <div class="stat-label">Rata-rata Pagu</div>
                        </div>
                    </div>
                    
                    <div class="preview-container">
                        <table class="preview-table" id="uploadPreviewTable">
                            <thead id="uploadPreviewHead">
                                <!-- Headers akan diisi secara dinamis -->
                            </thead>
                            <tbody id="uploadPreviewBody">
                                <!-- Preview rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Review Data -->
            <div id="step2-section" class="section" style="display: none;">
                <h2>2. Review Data RKA</h2>
                
                <div class="alert alert-info">
                    <strong>Periksa data RKA yang telah diupload:</strong> Pastikan data sudah benar sebelum melanjutkan ke konfigurasi distribusi.
                </div>
                
                <div id="reviewStats">
                    <!-- Statistik akan ditampilkan di sini -->
                </div>
                
                <h3>Ringkasan per OPD/SKPD</h3>
                <div id="opdSummary">
                    <!-- Ringkasan OPD akan ditampilkan di sini -->
                </div>
                
                <div class="actions">
                    <button id="btnBackToUpload" class="btn btn-secondary">
                        Kembali ke Upload
                    </button>
                    <button id="btnToConfiguration" class="btn btn-primary">
                        Lanjut ke Konfigurasi
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Konfigurasi Distribusi -->
            <div id="step3-section" class="section" style="display: none;">
                <h2>3. Konfigurasi Pola Distribusi</h2>
                
                <div class="alert alert-info">
                    Pilih pola distribusi yang akan diterapkan untuk membagi pagu belanja per bulan. <br>
                    <strong>Catatan Penting:</strong> 
                    <ul>
                        <li>Alokasi per bulan akan berupa bilangan bulat (tidak ada angka desimal)</li>
                        <li>Total alokasi akan sama persis dengan pagu (selisih pembulatan = 0)</li>
                        <li>UP (Uang Persediaan) akan tetap dibulatkan ke ribuan</li>
                    </ul>
                </div>
                
                <div class="mode-grid">
                    <div class="mode-card" data-mode="monthly">
                        <div class="mode-icon">üìÖ</div>
                        <div class="mode-title">Bulanan (Merata)</div>
                        <div class="mode-desc">Bagikan pagu secara merata ke semua bulan aktif dengan bilangan bulat</div>
                    </div>
                    
                    <div class="mode-card" data-mode="quarterly">
                        <div class="mode-icon">üìä</div>
                        <div class="mode-title">Triwulan</div>
                        <div class="mode-desc">Atur persentase per triwulan, dibagi rata per bulan dalam triwulan dengan bilangan bulat</div>
                    </div>
                    
                    <div class="mode-card" data-mode="semester">
                        <div class="mode-icon">üìà</div>
                        <div class="mode-title">Semester</div>
                        <div class="mode-desc">Atur persentase per semester, dibagi rata per bulan dalam semester dengan bilangan bulat</div>
                    </div>
                    
                    <div class="mode-card" data-mode="custom">
                        <div class="mode-icon">üéõÔ∏è</div>
                        <div class="mode-title">Custom Global</div>
                        <div class="mode-desc">Atur persentase manual untuk setiap bulan (sama untuk semua kelompok) dengan bilangan bulat</div>
                    </div>
                    
                    <div class="mode-card" data-mode="per-kelompok">
                        <div class="mode-icon">üè¢</div>
                        <div class="mode-title">Per Jenis Belanja</div>
                        <div class="mode-desc">Atur persentase berbeda untuk setiap jenis belanja dengan bilangan bulat</div>
                    </div>
                </div>
                
                <div id="modeConfigSection" style="display: none; margin-top: 30px;">
                    <h3 id="modeConfigTitle"></h3>
                    <div id="modeConfigContent">
                        <!-- Config content will be inserted here -->
                    </div>
                    
                    <div id="groupConfigSection" style="display: none; margin-top: 30px;">
                        <h4>Konfigurasi Per Jenis Belanja</h4>
                        <div class="alert alert-warning">
                            <strong>Perhatian:</strong> Pastikan total persentase untuk setiap kelompok = 100%
                        </div>
                        <div id="groupConfigTableContainer">
                            <!-- Tabel konfigurasi kelompok akan diisi di sini -->
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button id="btnBackToReview" class="btn btn-secondary">
                            Kembali ke Review
                        </button>
                        <button id="btnToPreview" class="btn btn-primary">
                            Lanjut ke Preview
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Preview Konfigurasi -->
            <div id="step4-section" class="section" style="display: none;">
                <h2>4. Preview Konfigurasi</h2>
                
                <div class="alert alert-warning">
                    <strong>Periksa konfigurasi sebelum memproses:</strong> Pastikan pola distribusi sesuai dengan kebutuhan
                </div>
                
                <div id="previewConfig">
                    <!-- Preview config will be inserted here -->
                </div>
                
                <div class="actions">
                    <button id="btnBackToConfig" class="btn btn-secondary">
                        Kembali ke Konfigurasi
                    </button>
                    <button id="btnProcess" class="btn btn-primary">
                        Proses Pembagian Pagu
                    </button>
                </div>
            </div>
            
            <!-- Step 5: Hasil -->
            <div id="step5-section" class="section results-section">
                <h2>5. Hasil Pembagian Pagu</h2>
                
                <div class="summary-cards">
                    <div class="result-card">
                        <div class="result-title">Total Pagu</div>
                        <div class="result-value" id="resultTotalPagu">0</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">Total Setelah Dibagi</div>
                        <div class="result-value" id="resultTotalAllocated">0</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">Selisih (Pembulatan)</div>
                        <div class="result-value" id="resultDifference">0</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">Jumlah Item</div>
                        <div class="result-value" id="resultItemCount">0</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">Pola Distribusi</div>
                        <div class="result-value" id="resultMode">-</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">Total UP (10%)</div>
                        <div class="result-value" id="resultTotalUP">0</div>
                    </div>
                </div>
                
                <div class="tabs">
                    <button class="tab-btn active" data-tab="chart">Grafik</button>
                    <button class="tab-btn" data-tab="summary">Ringkasan</button>
                    <button class="tab-btn" data-tab="groupSummary">Ringkasan Jenis Belanja</button>
                    <button class="tab-btn" data-tab="upSummary">Ringkasan UP</button>
                    <button class="tab-btn" data-tab="opdJenis">Per OPD per Jenis Belanja</button>
                    <button class="tab-btn" data-tab="details">Detail Per Bulan</button>
                    <button class="tab-btn" data-tab="data">Data Lengkap</button>
                </div>
                
                <div class="tab-content">
                    <div id="tabChart" class="tab-pane active">
                        <div class="chart-container">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>
                    
                    <div id="tabSummary" class="tab-pane">
                        <div id="summaryTable"></div>
                    </div>
                    
                    <div id="tabGroupSummary" class="tab-pane">
                        <div id="groupSummaryTable"></div>
                    </div>
                    
                    <div id="tabUpSummary" class="tab-pane">
                        <div id="upSummaryTable"></div>
                    </div>
                    
                    <div id="tabOpdJenis" class="tab-pane">
                        <div id="opdJenisTable"></div>
                    </div>
                    
                    <div id="tabDetails" class="tab-pane">
                        <div class="data-table-container">
                            <table class="data-table" id="monthlyTable">
                                <thead>
                                    <tr>
                                        <th>Bulan</th>
                                        <th class="text-right">Alokasi</th>
                                        <th class="text-right">Persentase</th>
                                        <th class="text-right">% dari Total</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyTableBody">
                                    <!-- Monthly data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="tabData" class="tab-pane">
                        <div class="alert alert-info">
                            Menampilkan 100 baris pertama. Data lengkap dapat diunduh dalam format Excel.
                        </div>
                        <div class="data-table-container">
                            <table class="data-table" id="resultTable">
                                <thead id="resultTableHead">
                                    <!-- Headers akan diisi secara dinamis -->
                                </thead>
                                <tbody id="resultTableBody">
                                    <!-- Result data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button id="btnNewProcess" class="btn btn-secondary">
                        Proses Baru
                    </button>
                    <button id="btnDownloadExcel" class="btn btn-success">
                        Download Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===============================
        // 1. DATA STRUCTURES & CONSTANTS
        // ===============================
        
        const BULAN_INDONESIA = [
            'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
            'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
        ];
        
        const BULAN_SINGKAT = [
            'Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun',
            'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'
        ];
        
        // Jenis belanja berdasarkan 3 digit pertama kode rekening
        const JENIS_BELANJA = {
            '5.2.03': 'Belanja Modal Bangunan dan Gedung',
            '5.1.02': 'Belanja Barang dan Jasa',
            '5.2.02': 'Belanja Modal Peralatan dan Mesin',
            '5.2.05': 'Belanja Modal Aset Tetap Lainnya',
            '5.1.05': 'Belanja Hibah',
            '5.1.01': 'Belanja Pegawai',
            '5.2.06': 'Belanja Modal Aset Lainnya',
            '5.2.04': 'Belanja Modal Jalan, Jaringan dan Irigasi',
            '5.2.01': 'Belanja Modal Tanah',
            '5.1.06': 'Belanja Bantuan Sosial',
            '5.4.01': 'Belanja Bagi Hasil',
            '5.4.02': 'Belanja Bantuan Keuangan',
            '5.3.01': 'Belanja Tidak Terduga'
        };
        
        const KODE_BELANJA_BARANG_JASA = '5.1.02'; // Kode untuk Belanja Barang dan Jasa
        
        const STANDARD_COLUMNS = [
            'NO', 'TAHUN', 'KODE URUSAN', 'NAMA URUSAN', 'KODE SKPD', 'NAMA SKPD',
            'KODE SUB UNIT', 'NAMA SUB UNIT', 'KODE BIDANG URUSAN', 'NAMA BIDANG URUSAN',
            'KODE PROGRAM', 'NAMA PROGRAM', 'KODE KEGIATAN', 'NAMA KEGIATAN',
            'KODE SUB KEGIATAN', 'NAMA SUB KEGIATAN', 'KODE SUMBER DANA', 'NAMA SUMBER DANA',
            'KODE REKENING', 'NAMA REKENING', 'PAGU'
        ];
        
        // Default persentase per bulan untuk konfigurasi per jenis belanja
        const DEFAULT_PERCENTAGES = [20, 20, 10, 7, 7, 6, 7, 7, 6, 4, 3, 3];
        
        // ===============================
        // 2. UTILITY FUNCTIONS
        // ===============================
        
        // Fungsi pembulatan ke ribuan (HANYA untuk UP)
        function roundToThousands(number) {
            return Math.round(number / 1000) * 1000;
        }
        
        // Fungsi untuk memformat angka tanpa pembulatan (2 desimal)
        function formatNumberExact(number) {
            const num = parseFloat(number) || 0;
            return num.toLocaleString('id-ID', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // Fungsi untuk memformat angka integer (tanpa desimal)
        function formatInteger(number) {
            const num = parseInt(number) || 0;
            return num.toLocaleString('id-ID', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }
        
        // Fungsi untuk memformat angka dengan pembulatan ribuan (untuk UP saja)
        function formatRoundedNumber(number) {
            const rounded = roundToThousands(number);
            return rounded.toLocaleString('id-ID', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }
        
        function extractGroupFromKodeRekening(kodeRekening) {
            if (!kodeRekening) return null;
            
            const kodeStr = kodeRekening.toString();
            // Ambil 3 digit pertama (format: X.X.X)
            const parts = kodeStr.split('.');
            if (parts.length >= 3) {
                return `${parts[0]}.${parts[1]}.${parts[2]}`;
            }
            return null;
        }
        
        function getGroupName(groupCode) {
            return JENIS_BELANJA[groupCode] || `Jenis ${groupCode}`;
        }
        
        // ===============================
        // 3. APPLICATION STATE
        // ===============================
        
        let appState = {
            uploadedData: null,
            originalHeaders: [],
            opdSummary: null,
            selectedMode: 'monthly',
            modeConfig: {},
            groupConfig: {}, // Konfigurasi per jenis belanja
            processedData: null,
            monthlyTotals: new Array(12).fill(0),
            groupMonthlyTotals: {}, // Total per jenis belanja per bulan
            chart: null,
            upSummary: null, // Ringkasan UP per OPD
            opdJenisSummary: null // Ringkasan per OPD per Jenis Belanja
        };
        
        // ===============================
        // 4. DISTRIBUTION ENGINE DENGAN BILANGAN BULAT
        // ===============================
        
        class DistributionEngine {
            // Algoritma distribusi bilangan bulat tanpa selisih
            distributeInteger(pagu, percentages) {
                const allocations = new Array(12).fill(0);
                
                // Jika pagu = 0, kembalikan array nol
                if (pagu <= 0) return allocations;
                
                // Hitung alokasi desimal berdasarkan persentase
                const decimalAllocations = percentages.map(p => (pagu * p) / 100);
                
                // Ambil bagian integer dari setiap alokasi (bulatkan ke bawah)
                const intAllocations = decimalAllocations.map(a => Math.floor(a));
                
                // Hitung total integer dan selisih
                const totalInt = intAllocations.reduce((sum, a) => sum + a, 0);
                let remainder = pagu - totalInt;
                
                // Distribusikan sisa ke bulan-bulan dengan pecahan terbesar
                if (remainder > 0) {
                    // Buat array objek dengan index dan pecahan
                    const fractions = decimalAllocations.map((a, i) => ({
                        index: i,
                        fraction: a - intAllocations[i]
                    }));
                    
                    // Urutkan berdasarkan pecahan terbesar
                    fractions.sort((a, b) => b.fraction - a.fraction);
                    
                    // Tambahkan 1 ke bulan dengan pecahan terbesar hingga sisa habis
                    for (let i = 0; i < remainder; i++) {
                        intAllocations[fractions[i % fractions.length].index] += 1;
                    }
                }
                
                return intAllocations;
            }
            
            // Hitung persentase berdasarkan mode
            calculatePercentages(mode, config) {
                const percentages = new Array(12).fill(0);
                
                switch (mode) {
                    case 'monthly':
                        const numMonths = config.numMonths || 12;
                        const startMonth = config.startMonth || 0;
                        const monthlyPercent = 100 / numMonths;
                        
                        for (let i = startMonth; i < startMonth + numMonths && i < 12; i++) {
                            percentages[i] = monthlyPercent;
                        }
                        break;
                        
                    case 'quarterly':
                        const quarters = [
                            { percent: config.q1 || 25, months: [0, 1, 2] },
                            { percent: config.q2 || 25, months: [3, 4, 5] },
                            { percent: config.q3 || 25, months: [6, 7, 8] },
                            { percent: config.q4 || 25, months: [9, 10, 11] }
                        ];
                        
                        quarters.forEach(quarter => {
                            const monthlyPercent = quarter.percent / 3;
                            quarter.months.forEach(month => {
                                percentages[month] = monthlyPercent;
                            });
                        });
                        break;
                        
                    case 'semester':
                        const semesters = [
                            { percent: config.semester1 || 50, months: [0, 1, 2, 3, 4, 5] },
                            { percent: config.semester2 || 50, months: [6, 7, 8, 9, 10, 11] }
                        ];
                        
                        semesters.forEach(semester => {
                            const monthlyPercent = semester.percent / 6;
                            semester.months.forEach(month => {
                                percentages[month] = monthlyPercent;
                            });
                        });
                        break;
                        
                    case 'custom':
                        if (Array.isArray(config)) {
                            config.forEach((percent, index) => {
                                if (index < 12) percentages[index] = percent;
                            });
                        } else {
                            Object.entries(config).forEach(([month, percent]) => {
                                const monthIndex = parseInt(month) - 1;
                                if (monthIndex >= 0 && monthIndex < 12) {
                                    percentages[monthIndex] = percent;
                                }
                            });
                        }
                        break;
                        
                    case 'per-kelompok':
                        // Untuk mode ini, persentase dikembalikan langsung dari config
                        return config;
                }
                
                return percentages;
            }
            
            // Main distribution function untuk bilangan bulat
            distributeIntegerWithMode(pagu, mode, config) {
                const percentages = this.calculatePercentages(mode, config);
                return this.distributeInteger(pagu, percentages);
            }
            
            // Untuk mode per-kelompok
            distributeIntegerWithGroup(pagu, groupConfig) {
                return this.distributeInteger(pagu, groupConfig);
            }
        }
        
        // ===============================
        // 5. FILE PROCESSING
        // ===============================
        
        class FileProcessor {
            constructor() {
                this.distributionEngine = new DistributionEngine();
            }
            
            async parseExcel(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            if (jsonData.length === 0) {
                                reject(new Error('File Excel kosong'));
                                return;
                            }
                            
                            // Find headers (first non-empty row)
                            let headerRowIndex = 0;
                            for (let i = 0; i < jsonData.length; i++) {
                                if (jsonData[i] && jsonData[i].some(cell => cell && cell.toString().trim() !== '')) {
                                    headerRowIndex = i;
                                    break;
                                }
                            }
                            
                            const headers = jsonData[headerRowIndex];
                            const rows = jsonData.slice(headerRowIndex + 1);
                            
                            // Simpan header asli
                            appState.originalHeaders = headers;
                            
                            // Map column names to standard names
                            const columnMapping = this.mapColumns(headers);
                            
                            const structuredData = rows
                                .filter(row => {
                                    // Filter out empty rows
                                    return row && row.some(cell => cell && cell.toString().trim() !== '');
                                })
                                .map((row, index) => {
                                    const item = {};
                                    headers.forEach((header, colIndex) => {
                                        const value = row[colIndex] || '';
                                        const mappedHeader = columnMapping[header] || header;
                                        item[mappedHeader] = value;
                                    });
                                    
                                    // Ensure we have pagu as number
                                    item.PAGU = parseFloat(item.PAGU) || 0;
                                    
                                    // Extract jenis belanja from kode rekening
                                    const kodeRekening = item['KODE REKENING'] || '';
                                    item.JENIS_BELANJA = extractGroupFromKodeRekening(kodeRekening);
                                    item.JENIS_BELANJA_NAME = getGroupName(item.JENIS_BELANJA);
                                    
                                    // Add original row number
                                    item._rowNumber = index + headerRowIndex + 2;
                                    
                                    return item;
                                })
                                .filter(item => item.PAGU > 0);
                            
                            resolve(structuredData);
                        } catch (error) {
                            reject(new Error('Error membaca file Excel: ' + error.message));
                        }
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('Error membaca file'));
                    };
                    
                    reader.readAsArrayBuffer(file);
                });
            }
            
            mapColumns(headers) {
                const mapping = {};
                const columnPatterns = {
                    'NO': ['no', 'nomor'],
                    'TAHUN': ['tahun'],
                    'KODE URUSAN': ['kode urusan'],
                    'NAMA URUSAN': ['nama urusan'],
                    'KODE SKPD': ['kode skpd'],
                    'NAMA SKPD': ['nama skpd', 'skpd', 'opd', 'satker', 'satuan kerja'],
                    'KODE SUB UNIT': ['kode sub unit'],
                    'NAMA SUB UNIT': ['nama sub unit'],
                    'KODE BIDANG URUSAN': ['kode bidang urusan'],
                    'NAMA BIDANG URUSAN': ['nama bidang urusan'],
                    'KODE PROGRAM': ['kode program'],
                    'NAMA PROGRAM': ['nama program'],
                    'KODE KEGIATAN': ['kode kegiatan'],
                    'NAMA KEGIATAN': ['nama kegiatan'],
                    'KODE SUB KEGIATAN': ['kode sub kegiatan'],
                    'NAMA SUB KEGIATAN': ['nama sub kegiatan'],
                    'KODE SUMBER DANA': ['kode sumber dana'],
                    'NAMA SUMBER DANA': ['nama sumber dana'],
                    'KODE REKENING': ['kode rekening', 'kode_rekening', 'kd rek'],
                    'NAMA REKENING': ['nama rekening', 'uraian', 'uraian kegiatan', 'nm rek'],
                    'PAGU': ['pagu', 'anggaran', 'jumlah', 'nilai', 'total']
                };
                
                headers.forEach((header, index) => {
                    if (!header) {
                        mapping[`Kolom_${index + 1}`] = `Kolom_${index + 1}`;
                        return;
                    }
                    
                    const headerLower = header.toString().toLowerCase().trim();
                    let found = false;
                    
                    for (const [standardName, patterns] of Object.entries(columnPatterns)) {
                        for (const pattern of patterns) {
                            if (headerLower.includes(pattern.toLowerCase())) {
                                mapping[header] = standardName;
                                found = true;
                                break;
                            }
                        }
                        if (found) break;
                    }
                    
                    if (!found) {
                        mapping[header] = header;
                    }
                });
                
                return mapping;
            }
            
            analyzeOPDSummary(data) {
                const opdMap = new Map();
                let totalPagu = 0;
                
                data.forEach(item => {
                    const opdName = item['NAMA SKPD'] || item['KODE SKPD'] || item['KODE SUB UNIT'] || 'Tidak Ada OPD';
                    const pagu = item.PAGU || 0;
                    
                    if (!opdMap.has(opdName)) {
                        opdMap.set(opdName, {
                            name: opdName,
                            totalPagu: 0,
                            itemCount: 0,
                            minPagu: Infinity,
                            maxPagu: 0,
                            avgPagu: 0
                        });
                    }
                    
                    const opdData = opdMap.get(opdName);
                    opdData.totalPagu += pagu;
                    opdData.itemCount += 1;
                    opdData.minPagu = Math.min(opdData.minPagu, pagu);
                    opdData.maxPagu = Math.max(opdData.maxPagu, pagu);
                    
                    totalPagu += pagu;
                });
                
                // Calculate averages
                opdMap.forEach(opdData => {
                    opdData.avgPagu = opdData.totalPagu / opdData.itemCount;
                });
                
                // Convert to array and sort by total pagu
                const opdArray = Array.from(opdMap.values());
                opdArray.sort((a, b) => b.totalPagu - a.totalPagu);
                
                return {
                    totalOPD: opdArray.length,
                    totalPagu: totalPagu,
                    opdDetails: opdArray,
                    hasOPDColumn: data.some(item => item['NAMA SKPD'] || item['KODE SKPD'])
                };
            }
            
            analyzeGroupSummary(data) {
                const groupMap = new Map();
                let totalPagu = 0;
                
                data.forEach(item => {
                    const groupCode = item.JENIS_BELANJA || 'Tidak Diketahui';
                    const groupName = item.JENIS_BELANJA_NAME || getGroupName(groupCode);
                    const pagu = item.PAGU || 0;
                    
                    if (!groupMap.has(groupCode)) {
                        groupMap.set(groupCode, {
                            code: groupCode,
                            name: groupName,
                            totalPagu: 0,
                            itemCount: 0,
                            minPagu: Infinity,
                            maxPagu: 0,
                            avgPagu: 0
                        });
                    }
                    
                    const groupData = groupMap.get(groupCode);
                    groupData.totalPagu += pagu;
                    groupData.itemCount += 1;
                    groupData.minPagu = Math.min(groupData.minPagu, pagu);
                    groupData.maxPagu = Math.max(groupData.maxPagu, pagu);
                    
                    totalPagu += pagu;
                });
                
                // Calculate averages
                groupMap.forEach(groupData => {
                    groupData.avgPagu = groupData.totalPagu / groupData.itemCount;
                });
                
                // Convert to array and sort by total pagu
                const groupArray = Array.from(groupMap.values());
                groupArray.sort((a, b) => b.totalPagu - a.totalPagu);
                
                return {
                    totalGroups: groupArray.length,
                    totalPagu: totalPagu,
                    groupDetails: groupArray
                };
            }
            
            analyzeOpdJenisSummary(data) {
                const opdMap = new Map();
                
                data.forEach(item => {
                    const opdName = item['NAMA SKPD'] || item['KODE SKPD'] || item['KODE SUB UNIT'] || 'Tidak Ada OPD';
                    const jenisKode = item.JENIS_BELANJA || 'Tidak Diketahui';
                    const jenisName = item.JENIS_BELANJA_NAME || getGroupName(jenisKode);
                    const pagu = item.PAGU || 0;
                    
                    if (!opdMap.has(opdName)) {
                        opdMap.set(opdName, new Map());
                    }
                    
                    const jenisMap = opdMap.get(opdName);
                    
                    if (!jenisMap.has(jenisKode)) {
                        jenisMap.set(jenisKode, {
                            code: jenisKode,
                            name: jenisName,
                            totalPagu: 0,
                            itemCount: 0
                        });
                    }
                    
                    const jenisData = jenisMap.get(jenisKode);
                    jenisData.totalPagu += pagu;
                    jenisData.itemCount += 1;
                });
                
                // Convert to array structure
                const opdArray = [];
                opdMap.forEach((jenisMap, opdName) => {
                    const jenisArray = Array.from(jenisMap.values());
                    jenisArray.sort((a, b) => b.totalPagu - a.totalPagu);
                    
                    opdArray.push({
                        name: opdName,
                        jenisBelanja: jenisArray,
                        totalPagu: jenisArray.reduce((sum, item) => sum + item.totalPagu, 0),
                        totalItem: jenisArray.reduce((sum, item) => sum + item.itemCount, 0)
                    });
                });
                
                // Sort by total pagu descending
                opdArray.sort((a, b) => b.totalPagu - a.totalPagu);
                
                return opdArray;
            }
            
            calculateUP(data) {
                const upSummary = new Map();
                
                data.forEach(item => {
                    const opdName = item['NAMA SKPD'] || item['KODE SKPD'] || item['KODE SUB UNIT'] || 'Tidak Ada OPD';
                    const groupCode = item.JENIS_BELANJA || 'Tidak Diketahui';
                    const pagu = item.PAGU || 0;
                    
                    if (!upSummary.has(opdName)) {
                        upSummary.set(opdName, {
                            name: opdName,
                            totalPagu: 0,
                            totalBelanjaBarangJasa: 0,
                            up: 0
                        });
                    }
                    
                    const opdData = upSummary.get(opdName);
                    opdData.totalPagu += pagu;
                    
                    // Jika ini adalah belanja barang jasa (kode 5.1.02)
                    if (groupCode === KODE_BELANJA_BARANG_JASA) {
                        opdData.totalBelanjaBarangJasa += pagu;
                    }
                });
                
                // Hitung UP (10% dari total belanja barang jasa) dan bulatkan ke ribuan
                upSummary.forEach(opdData => {
                    opdData.up = roundToThousands(opdData.totalBelanjaBarangJasa * 0.1);
                });
                
                return Array.from(upSummary.values());
            }
            
            applyDistribution(data, mode, config, groupConfig = null) {
                return data.map(item => {
                    const pagu = item.PAGU || 0;
                    let allocations;
                    
                    // Jika mode per-kelompok dan ada konfigurasi untuk jenis belanja ini
                    if (mode === 'per-kelompok' && groupConfig && item.JENIS_BELANJA && groupConfig[item.JENIS_BELANJA]) {
                        allocations = this.distributionEngine.distributeIntegerWithGroup(pagu, groupConfig[item.JENIS_BELANJA]);
                    } else {
                        allocations = this.distributionEngine.distributeIntegerWithMode(pagu, mode, config);
                    }
                    
                    // Hitung total alokasi setelah distribusi
                    const totalAllocated = allocations.reduce((sum, val) => sum + val, 0);
                    
                    return {
                        ...item,
                        allocations: allocations,
                        totalAllocated: totalAllocated,
                        distributionMode: mode
                    };
                });
            }
            
            // Validasi bahwa total alokasi = total pagu
            validateAllocation(data) {
                let totalPagu = 0;
                let totalAllocated = 0;
                
                data.forEach(item => {
                    totalPagu += item.PAGU;
                    totalAllocated += item.totalAllocated;
                });
                
                const diff = Math.abs(totalAllocated - totalPagu);
                
                return {
                    isValid: diff === 0,
                    totalPagu: totalPagu,
                    totalAllocated: totalAllocated,
                    difference: diff
                };
            }
        }
        
        // ===============================
        // 6. UI MANAGEMENT
        // ===============================
        
        class UIManager {
            constructor() {
                this.fileProcessor = new FileProcessor();
                this.initEventListeners();
            }
            
            initEventListeners() {
                // File upload
                const fileInput = document.getElementById('rkaFile');
                const dropArea = document.getElementById('dropArea');
                
                fileInput.addEventListener('change', (e) => this.handleFileUpload(e.target.files[0]));
                
                // Drag and drop
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.classList.add('dragover');
                });
                
                dropArea.addEventListener('dragleave', () => {
                    dropArea.classList.remove('dragover');
                });
                
                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                        this.handleFileUpload(file);
                    } else {
                        this.showAlert('Silakan unggah file Excel (.xlsx atau .xls)', 'warning');
                    }
                });
                
                // Mode selection
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const mode = card.getAttribute('data-mode');
                        this.selectMode(mode);
                    });
                });
                
                // Process buttons
                document.getElementById('btnProcess').addEventListener('click', () => this.processData());
                document.getElementById('btnBackToConfig').addEventListener('click', () => this.goToStep(3));
                document.getElementById('btnNewProcess').addEventListener('click', () => this.resetProcess());
                document.getElementById('btnDownloadExcel').addEventListener('click', () => this.downloadExcel());
                
                // Step navigation
                document.getElementById('btnBackToUpload').addEventListener('click', () => this.goToStep(1));
                document.getElementById('btnToConfiguration').addEventListener('click', () => this.goToStep(3));
                document.getElementById('btnBackToReview').addEventListener('click', () => this.goToStep(2));
                document.getElementById('btnToPreview').addEventListener('click', () => this.goToStep(4));
                
                // Tab switching
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-btn')) {
                        const tabName = e.target.getAttribute('data-tab');
                        this.switchTab(tabName);
                    }
                });
            }
            
            async handleFileUpload(file) {
                if (!file) return;
                
                try {
                    this.showLoading(true);
                    
                    const data = await this.fileProcessor.parseExcel(file);
                    
                    if (data.length === 0) {
                        throw new Error('Tidak ada data dengan pagu yang valid ditemukan');
                    }
                    
                    appState.uploadedData = data;
                    
                    // Calculate statistics
                    const totalRows = data.length;
                    const totalPagu = data.reduce((sum, item) => sum + (item.PAGU || 0), 0);
                    const avgPagu = totalRows > 0 ? totalPagu / totalRows : 0;
                    
                    // Update UI with statistics
                    document.getElementById('totalRows').textContent = totalRows.toLocaleString('id-ID');
                    document.getElementById('totalPaguUpload').textContent = formatNumberExact(totalPagu);
                    document.getElementById('avgPagu').textContent = formatNumberExact(avgPagu);
                    
                    // Show preview table (first 10 rows)
                    this.showPreviewTable(data.slice(0, 10));
                    
                    // Show upload stats
                    document.getElementById('uploadStats').style.display = 'block';
                    
                    // Move to review step
                    this.goToStep(2);
                    
                    // Analyze OPD data
                    appState.opdSummary = this.fileProcessor.analyzeOPDSummary(data);
                    
                    // Show review data
                    this.showReviewData();
                    
                    this.showAlert(`Berhasil mengupload ${totalRows} baris data dengan total pagu ${formatNumberExact(totalPagu)}`, 'success');
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    this.showAlert(error.message, 'warning');
                } finally {
                    this.showLoading(false);
                }
            }
            
            showPreviewTable(data) {
                const thead = document.getElementById('uploadPreviewHead');
                const tbody = document.getElementById('uploadPreviewBody');
                
                thead.innerHTML = '';
                tbody.innerHTML = '';
                
                // Create header row
                const headerRow = document.createElement('tr');
                
                // Tampilkan kolom penting saja untuk preview
                const previewColumns = ['NO', 'KODE SKPD', 'NAMA SKPD', 'KODE REKENING', 'NAMA REKENING', 'PAGU', 'JENIS_BELANJA'];
                
                previewColumns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                
                // Create data rows
                data.forEach((item, index) => {
                    const row = document.createElement('tr');
                    
                    previewColumns.forEach(col => {
                        let value = item[col] !== undefined ? item[col] : '';
                        
                        // Format khusus untuk PAGU (tampilkan tanpa pembulatan)
                        if (col === 'PAGU') {
                            value = formatNumberExact(value);
                        }
                        
                        // Format jenis belanja
                        if (col === 'JENIS_BELANJA' && value) {
                            value = getGroupName(value) || value;
                        }
                        
                        const cell = document.createElement('td');
                        cell.textContent = value;
                        
                        if (col === 'PAGU') {
                            cell.className = 'text-right';
                        }
                        
                        row.appendChild(cell);
                    });
                    
                    tbody.appendChild(row);
                });
            }
            
            showReviewData() {
                if (!appState.opdSummary) return;
                
                const summary = appState.opdSummary;
                const totalRows = appState.uploadedData.length;
                const totalPagu = this.getTotalPagu();
                
                // Analisis kelompok
                const groupSummary = this.fileProcessor.analyzeGroupSummary(appState.uploadedData);
                
                // Update review stats
                let reviewStatsHTML = `
                    <div class="stats-summary">
                        <div class="stat-card">
                            <div class="stat-value">${totalRows.toLocaleString('id-ID')}</div>
                            <div class="stat-label">Total Baris Data</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summary.totalOPD}</div>
                            <div class="stat-label">Jumlah OPD/SKPD</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${groupSummary.totalGroups}</div>
                            <div class="stat-label">Jumlah Jenis Belanja</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatNumberExact(totalPagu)}</div>
                            <div class="stat-label">Total Pagu</div>
                        </div>
                    </div>
                `;
                
                if (!summary.hasOPDColumn) {
                    reviewStatsHTML += `
                        <div class="alert alert-warning">
                            <strong>Catatan:</strong> Kolom "NAMA SKPD" tidak ditemukan. Pengelompokan OPD dilakukan berdasarkan data yang tersedia.
                        </div>
                    `;
                }
                
                document.getElementById('reviewStats').innerHTML = reviewStatsHTML;
                
                // Update OPD summary
                let opdSummaryHTML = `
                    <div class="alert alert-info">
                        <strong>${summary.totalOPD} OPD/SKPD ditemukan</strong> dengan total pagu ${formatNumberExact(totalPagu)}
                    </div>
                    <div class="data-table-container">
                        <table class="opd-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>OPD / SKPD / Unit Kerja</th>
                                    <th class="text-right">Jumlah Item</th>
                                    <th class="text-right">Total Pagu</th>
                                    <th class="text-right">Rata-rata</th>
                                    <th class="text-right">Min</th>
                                    <th class="text-right">Max</th>
                                    <th class="text-right">% dari Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                summary.opdDetails.forEach((opd, index) => {
                    const percentage = totalPagu > 0 ? ((opd.totalPagu / totalPagu) * 100).toFixed(2) : 0;
                    opdSummaryHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><span class="opd-badge">${opd.name}</span></td>
                            <td class="text-right">${opd.itemCount.toLocaleString('id-ID')}</td>
                            <td class="text-right">${formatNumberExact(opd.totalPagu)}</td>
                            <td class="text-right">${formatNumberExact(opd.avgPagu)}</td>
                            <td class="text-right">${formatNumberExact(opd.minPagu)}</td>
                            <td class="text-right">${formatNumberExact(opd.maxPagu)}</td>
                            <td class="text-right">${percentage}%</td>
                        </tr>
                    `;
                });
                
                // Add total row
                opdSummaryHTML += `
                            </tbody>
                            <tfoot>
                                <tr style="background-color: #f8f9fa; font-weight: bold;">
                                    <td colspan="2">TOTAL</td>
                                    <td class="text-right">${totalRows.toLocaleString('id-ID')}</td>
                                    <td class="text-right">${formatNumberExact(totalPagu)}</td>
                                    <td class="text-right">${formatNumberExact(totalPagu / totalRows)}</td>
                                    <td class="text-right">${formatNumberExact(Math.min(...summary.opdDetails.map(o => o.minPagu)))}</td>
                                    <td class="text-right">${formatNumberExact(Math.max(...summary.opdDetails.map(o => o.maxPagu)))}</td>
                                    <td class="text-right">100%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                
                document.getElementById('opdSummary').innerHTML = opdSummaryHTML;
            }
            
            selectMode(mode) {
                appState.selectedMode = mode;
                
                // Update UI
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                document.querySelector(`.mode-card[data-mode="${mode}"]`).classList.add('selected');
                
                // Show configuration section
                document.getElementById('modeConfigSection').style.display = 'block';
                
                // Tampilkan/menyembunyikan konfigurasi jenis belanja
                if (mode === 'per-kelompok') {
                    document.getElementById('groupConfigSection').style.display = 'block';
                    document.getElementById('modeConfigTitle').textContent = 'Konfigurasi Per Jenis Belanja';
                    this.generateGroupConfigUI();
                } else {
                    document.getElementById('groupConfigSection').style.display = 'none';
                    document.getElementById('modeConfigTitle').textContent = `Konfigurasi Pola ${this.getModeName(mode)}`;
                    this.generateModeConfigUI(mode);
                }
            }
            
            getModeName(mode) {
                const modeNames = {
                    'monthly': 'Bulanan',
                    'quarterly': 'Triwulan',
                    'semester': 'Semester',
                    'custom': 'Custom Global',
                    'per-kelompok': 'Per Jenis Belanja'
                };
                return modeNames[mode] || mode;
            }
            
            generateModeConfigUI(mode) {
                const container = document.getElementById('modeConfigContent');
                
                switch (mode) {
                    case 'monthly':
                        container.innerHTML = `
                            <div class="form-group">
                                <label>Jumlah Bulan Aktif:</label>
                                <select id="numMonths" class="form-control">
                                    <option value="12">12 Bulan (Jan-Des)</option>
                                    <option value="11">11 Bulan</option>
                                    <option value="10">10 Bulan</option>
                                    <option value="9">9 Bulan</option>
                                    <option value="8">8 Bulan</option>
                                    <option value="7">7 Bulan</option>
                                    <option value="6">6 Bulan</option>
                                    <option value="5">5 Bulan</option>
                                    <option value="4">4 Bulan</option>
                                    <option value="3">3 Bulan</option>
                                    <option value="2">2 Bulan</option>
                                    <option value="1">1 Bulan</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mulai dari Bulan:</label>
                                <select id="startMonth" class="form-control">
                                    ${BULAN_INDONESIA.map((bulan, index) => 
                                        `<option value="${index}">${bulan}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="alert alert-info">
                                <strong>Catatan:</strong> Alokasi per bulan akan berupa bilangan bulat tanpa desimal.
                                Total alokasi akan sama persis dengan pagu (selisih = 0).
                            </div>
                        `;
                        break;
                        
                    case 'quarterly':
                        container.innerHTML = `
                            <div class="alert alert-info">
                                Atur persentase untuk setiap triwulan. Total harus 100%.
                                <br><strong>Catatan:</strong> Alokasi per bulan akan berupa bilangan bulat tanpa desimal.
                                Total alokasi akan sama persis dengan pagu (selisih = 0).
                            </div>
                            <div class="quarter-inputs">
                                <div class="quarter-box">
                                    <label>Triwulan 1 (Jan-Mar):</label>
                                    <input type="number" id="q1Percent" class="form-control" min="0" max="100" value="25" step="0.1">
                                    <small>% dari total pagu</small>
                                </div>
                                <div class="quarter-box">
                                    <label>Triwulan 2 (Apr-Jun):</label>
                                    <input type="number" id="q2Percent" class="form-control" min="0" max="100" value="25" step="0.1">
                                    <small>% dari total pagu</small>
                                </div>
                                <div class="quarter-box">
                                    <label>Triwulan 3 (Jul-Sep):</label>
                                    <input type="number" id="q3Percent" class="form-control" min="0" max="100" value="25" step="0.1">
                                    <small>% dari total pagu</small>
                                </div>
                                <div class="quarter-box">
                                    <label>Triwulan 4 (Okt-Des):</label>
                                    <input type="number" id="q4Percent" class="form-control" min="0" max="100" value="25" step="0.1">
                                    <small>% dari total pagu</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <button id="btnDistributeEvenlyQuarter" class="btn btn-secondary">
                                    Bagi Merata (25% per Triwulan)
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('btnDistributeEvenlyQuarter').addEventListener('click', () => {
                            document.querySelectorAll('#modeConfigContent input[type="number"]').forEach(input => {
                                input.value = 25;
                            });
                        });
                        break;
                        
                    case 'semester':
                        container.innerHTML = `
                            <div class="alert alert-info">
                                Atur persentase untuk setiap semester. Total harus 100%.
                                <br><strong>Catatan:</strong> Alokasi per bulan akan berupa bilangan bulat tanpa desimal.
                                Total alokasi akan sama persis dengan pagu (selisih = 0).
                            </div>
                            <div class="semester-inputs">
                                <div class="semester-box">
                                    <label>Semester 1 (Jan-Jun):</label>
                                    <input type="number" id="s1Percent" class="form-control" min="0" max="100" value="50" step="0.1">
                                    <small>% dari total pagu</small>
                                </div>
                                <div class="semester-box">
                                    <label>Semester 2 (Jul-Des):</label>
                                    <input type="number" id="s2Percent" class="form-control" min="0" max="100" value="50" step="0.1">
                                    <small>% dari total pagu</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <button id="btnDistributeEvenlySemester" class="btn btn-secondary">
                                    Bagi Merata (50% per Semester)
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('btnDistributeEvenlySemester').addEventListener('click', () => {
                            document.querySelectorAll('#modeConfigContent input[type="number"]').forEach(input => {
                                input.value = 50;
                            });
                        });
                        break;
                        
                    case 'custom':
                        container.innerHTML = `
                            <div class="alert alert-info">
                                Atur persentase untuk setiap bulan. Total harus 100%.
                                <br><strong>Catatan:</strong> Alokasi per bulan akan berupa bilangan bulat tanpa desimal.
                                Total alokasi akan sama persis dengan pagu (selisih = 0).
                            </div>
                            <div class="custom-month-inputs">
                                ${BULAN_INDONESIA.map((bulan, index) => `
                                    <div class="form-group">
                                        <label>${bulan}:</label>
                                        <input type="number" data-month="${index + 1}" 
                                               class="form-control month-percent" 
                                               min="0" max="100" value="${(100/12).toFixed(2)}" step="0.1">
                                    </div>
                                `).join('')}
                            </div>
                            <div class="form-group">
                                <button id="btnDistributeEvenlyCustom" class="btn btn-secondary">
                                    Bagi Merata (8.33% per Bulan)
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('btnDistributeEvenlyCustom').addEventListener('click', () => {
                            const inputs = document.querySelectorAll('.month-percent');
                            const evenValue = (100 / inputs.length).toFixed(2);
                            inputs.forEach(input => {
                                input.value = evenValue;
                            });
                        });
                        break;
                }
                
                // Add validation for percentage totals
                if (mode !== 'monthly') {
                    const inputs = container.querySelectorAll('input[type="number"]');
                    inputs.forEach(input => {
                        input.addEventListener('change', () => this.validatePercentages(mode));
                    });
                }
            }
            
            generateGroupConfigUI() {
                const container = document.getElementById('modeConfigContent');
                container.innerHTML = `
                    <div class="alert alert-info">
                        <strong>Konfigurasi Per Jenis Belanja:</strong> Atur persentase distribusi per bulan untuk setiap jenis belanja.
                        Sistem akan mengelompokkan data berdasarkan 3 digit pertama kode rekening.
                        <br><strong>Default: 20,20,10,7,7,6,7,7,6,4,3,3 (Total 100%)</strong>
                        <br><strong>Catatan:</strong> Alokasi per bulan akan berupa bilangan bulat tanpa desimal.
                        Total alokasi akan sama persis dengan pagu (selisih = 0).
                    </div>
                `;
                
                // Buat tabel konfigurasi jenis belanja
                this.createGroupConfigTable();
            }
            
            createGroupConfigTable() {
                if (!appState.uploadedData) return;
                
                const groupSummary = this.fileProcessor.analyzeGroupSummary(appState.uploadedData);
                const groups = groupSummary.groupDetails;
                
                let html = `
                    <div class="group-config-section">
                        <p><strong>Total ${groups.length} jenis belanja ditemukan dalam data:</strong></p>
                        <div class="data-table-container">
                            <table class="group-table">
                                <thead>
                                    <tr>
                                        <th class="group-name-cell">Jenis Belanja</th>
                                        ${BULAN_SINGKAT.map(bulan => `<th>${bulan}</th>`).join('')}
                                        <th>Total</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                groups.forEach((group, index) => {
                    html += `
                        <tr class="group-row">
                            <td class="group-name-cell">
                                <strong>${group.code}</strong><br>
                                <small>${group.name}</small><br>
                                <small>${formatNumberExact(group.totalPagu)} (${group.itemCount} item)</small>
                            </td>
                    `;
                    
                    // Input untuk setiap bulan dengan nilai default 20,20,10,7,7,6,7,7,6,4,3,3
                    for (let i = 0; i < 12; i++) {
                        html += `
                            <td>
                                <input type="number" 
                                       class="month-input group-percent" 
                                       data-group="${group.code}"
                                       data-month="${i}"
                                       value="${DEFAULT_PERCENTAGES[i]}"
                                       min="0" max="100" step="0.01">
                            </td>
                        `;
                    }
                    
                    // Kolom total dan status
                    html += `
                            <td class="text-right group-total" data-group="${group.code}">0.00%</td>
                            <td class="text-center group-status" data-group="${group.code}">
                                <span style="color: orange;">‚è≥</span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <button id="btnDistributeDefaultAllGroups" class="btn btn-secondary">
                                Set Default untuk Semua Jenis Belanja (20,20,10,7,7,6,7,7,6,4,3,3)
                            </button>
                            <button id="btnValidateGroups" class="btn btn-primary">
                                Validasi Semua Jenis Belanja
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('groupConfigTableContainer').innerHTML = html;
                
                // Event listeners
                document.querySelectorAll('.group-percent').forEach(input => {
                    input.addEventListener('input', (e) => this.updateGroupTotal(e.target));
                    input.addEventListener('change', (e) => this.updateGroupTotal(e.target));
                });
                
                document.getElementById('btnDistributeDefaultAllGroups').addEventListener('click', () => {
                    this.distributeDefaultAllGroups();
                });
                
                document.getElementById('btnValidateGroups').addEventListener('click', () => {
                    this.validateAllGroups();
                });
                
                // Initial update
                this.updateAllGroupTotals();
            }
            
            updateGroupTotal(input) {
                const groupCode = input.getAttribute('data-group');
                const inputs = document.querySelectorAll(`.group-percent[data-group="${groupCode}"]`);
                
                let total = 0;
                inputs.forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
                
                const totalCell = document.querySelector(`.group-total[data-group="${groupCode}"]`);
                const statusCell = document.querySelector(`.group-status[data-group="${groupCode}"]`);
                
                totalCell.textContent = `${total.toFixed(2)}%`;
                
                if (Math.abs(total - 100) < 0.01) {
                    totalCell.style.color = 'green';
                    totalCell.style.fontWeight = 'bold';
                    statusCell.innerHTML = '<span style="color: green;">‚úì</span>';
                } else {
                    totalCell.style.color = 'red';
                    totalCell.style.fontWeight = 'normal';
                    statusCell.innerHTML = '<span style="color: red;">‚úó</span>';
                }
            }
            
            updateAllGroupTotals() {
                const groupCodes = new Set();
                document.querySelectorAll('.group-percent').forEach(input => {
                    groupCodes.add(input.getAttribute('data-group'));
                });
                
                groupCodes.forEach(groupCode => {
                    const inputs = document.querySelectorAll(`.group-percent[data-group="${groupCode}"]`);
                    let total = 0;
                    inputs.forEach(input => {
                        total += parseFloat(input.value) || 0;
                    });
                    
                    const totalCell = document.querySelector(`.group-total[data-group="${groupCode}"]`);
                    const statusCell = document.querySelector(`.group-status[data-group="${groupCode}"]`);
                    
                    totalCell.textContent = `${total.toFixed(2)}%`;
                    
                    if (Math.abs(total - 100) < 0.01) {
                        totalCell.style.color = 'green';
                        totalCell.style.fontWeight = 'bold';
                        statusCell.innerHTML = '<span style="color: green;">‚úì</span>';
                    } else {
                        totalCell.style.color = 'red';
                        totalCell.style.fontWeight = 'normal';
                        statusCell.innerHTML = '<span style="color: red;">‚úó</span>';
                    }
                });
            }
            
            distributeDefaultAllGroups() {
                document.querySelectorAll('.group-percent').forEach((input, index) => {
                    const monthIndex = index % 12;
                    input.value = DEFAULT_PERCENTAGES[monthIndex];
                });
                this.updateAllGroupTotals();
            }
            
            validateAllGroups() {
                const groupCodes = new Set();
                document.querySelectorAll('.group-percent').forEach(input => {
                    groupCodes.add(input.getAttribute('data-group'));
                });
                
                let allValid = true;
                const invalidGroups = [];
                
                groupCodes.forEach(groupCode => {
                    const inputs = document.querySelectorAll(`.group-percent[data-group="${groupCode}"]`);
                    let total = 0;
                    inputs.forEach(input => {
                        total += parseFloat(input.value) || 0;
                    });
                    
                    if (Math.abs(total - 100) > 0.01) {
                        allValid = false;
                        invalidGroups.push(groupCode);
                    }
                });
                
                if (allValid) {
                    this.showAlert('Semua jenis belanja sudah valid (total = 100%)', 'success');
                } else {
                    this.showAlert(`Masih ada ${invalidGroups.length} jenis belanja yang totalnya tidak 100%`, 'warning');
                }
                
                return allValid;
            }
            
            getGroupConfigFromUI() {
                const groupConfig = {};
                const groupCodes = new Set();
                
                document.querySelectorAll('.group-percent').forEach(input => {
                    groupCodes.add(input.getAttribute('data-group'));
                });
                
                groupCodes.forEach(groupCode => {
                    const inputs = document.querySelectorAll(`.group-percent[data-group="${groupCode}"]`);
                    const percentages = Array.from(inputs).map(input => parseFloat(input.value) || 0);
                    groupConfig[groupCode] = percentages;
                });
                
                return groupConfig;
            }
            
            validatePercentages(mode) {
                let total = 0;
                
                switch (mode) {
                    case 'quarterly':
                        total = Array.from({length: 4}, (_, i) => 
                            parseFloat(document.getElementById(`q${i+1}Percent`).value) || 0
                        ).reduce((a, b) => a + b, 0);
                        break;
                        
                    case 'semester':
                        total = Array.from({length: 2}, (_, i) => 
                            parseFloat(document.getElementById(`s${i+1}Percent`).value) || 0
                        ).reduce((a, b) => a + b, 0);
                        break;
                        
                    case 'custom':
                        total = Array.from(document.querySelectorAll('.month-percent'))
                            .map(input => parseFloat(input.value) || 0)
                            .reduce((a, b) => a + b, 0);
                        break;
                }
                
                if (Math.abs(total - 100) > 0.1) {
                    this.showAlert(`Total persentase: ${total.toFixed(2)}% (harus 100%)`, 'warning');
                    return false;
                }
                
                return true;
            }
            
            goToStep(step) {
                // Update step indicators
                document.querySelectorAll('.step').forEach((stepEl, index) => {
                    stepEl.classList.remove('active', 'completed');
                    if (index + 1 < step) {
                        stepEl.classList.add('completed');
                    } else if (index + 1 === step) {
                        stepEl.classList.add('active');
                    }
                });
                
                // Show/hide sections
                document.getElementById('step1-section').style.display = step === 1 ? 'block' : 'none';
                document.getElementById('step2-section').style.display = step === 2 ? 'block' : 'none';
                document.getElementById('step3-section').style.display = step === 3 ? 'block' : 'none';
                document.getElementById('step4-section').style.display = step === 4 ? 'block' : 'none';
                document.getElementById('step5-section').style.display = step === 5 ? 'block' : 'none';
                
                // If going to step 3, initialize mode selection
                if (step === 3) {
                    if (!appState.selectedMode) {
                        appState.selectedMode = 'monthly';
                    }
                    this.selectMode(appState.selectedMode);
                }
                
                // If going to step 4, show preview
                if (step === 4) {
                    this.showPreviewConfig();
                }
                
                // Scroll to top of content
                document.querySelector('.content').scrollTop = 0;
            }
            
            showPreviewConfig() {
                const container = document.getElementById('previewConfig');
                const mode = appState.selectedMode;
                let config = this.getConfigFromUI();
                
                // Hitung UP untuk preview
                const upSummary = this.fileProcessor.calculateUP(appState.uploadedData);
                const totalUP = upSummary.reduce((sum, opd) => sum + opd.up, 0);
                
                let html = `
                    <div class="stats-summary">
                        <div class="stat-card">
                            <div class="stat-value">${appState.uploadedData.length.toLocaleString('id-ID')}</div>
                            <div class="stat-label">Jumlah Item</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatNumberExact(this.getTotalPagu())}</div>
                            <div class="stat-label">Total Pagu</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${appState.opdSummary?.totalOPD || 0}</div>
                            <div class="stat-label">Jumlah OPD</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${this.getModeName(mode)}</div>
                            <div class="stat-label">Pola Distribusi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatRoundedNumber(totalUP)}</div>
                            <div class="stat-label">Total UP (10% dari Belanja Barang Jasa)</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <strong>Catatan Penting:</strong>
                        <ul>
                            <li>Alokasi per bulan akan berupa bilangan bulat (tanpa desimal)</li>
                            <li>Total alokasi akan sama persis dengan pagu (selisih = 0)</li>
                            <li>UP (Uang Persediaan) akan dibulatkan ke ribuan</li>
                        </ul>
                    </div>
                    
                    <h3>Detail Konfigurasi:</h3>
                `;
                
                switch (mode) {
                    case 'monthly':
                        html += `
                            <div class="alert alert-info">
                                Pagu akan dibagi merata ke ${config.numMonths} bulan, mulai dari ${BULAN_INDONESIA[config.startMonth]}.
                                Setiap bulan akan menerima ${(100 / config.numMonths).toFixed(2)}% dari pagu.
                                <br><strong>Hasil alokasi per bulan akan berupa bilangan bulat tanpa desimal.</strong>
                            </div>
                        `;
                        break;
                        
                    case 'quarterly':
                        html += `
                            <div class="alert alert-info">
                                Pagu akan dibagi per triwulan dengan persentase sebagai berikut:
                                <br><strong>Hasil alokasi per bulan akan berupa bilangan bulat tanpa desimal.</strong>
                            </div>
                            <div class="quarter-inputs">
                                ${['Q1 (Jan-Mar)', 'Q2 (Apr-Jun)', 'Q3 (Jul-Sep)', 'Q4 (Okt-Des)'].map((label, index) => `
                                    <div class="quarter-box">
                                        <div class="stat-label">${label}</div>
                                        <div class="stat-value">${config[`q${index+1}`] || 0}%</div>
                                        <small>${(config[`q${index+1}`] / 3).toFixed(2)}% per bulan</small>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        break;
                        
                    case 'semester':
                        html += `
                            <div class="alert alert-info">
                                Pagu akan dibagi per semester dengan persentase sebagai berikut:
                                <br><strong>Hasil alokasi per bulan akan berupa bilangan bulat tanpa desimal.</strong>
                            </div>
                            <div class="semester-inputs">
                                <div class="semester-box">
                                    <div class="stat-label">Semester 1 (Jan-Jun)</div>
                                    <div class="stat-value">${config.semester1 || 0}%</div>
                                    <small>${(config.semester1 / 6).toFixed(2)}% per bulan</small>
                                </div>
                                <div class="semester-box">
                                    <div class="stat-label">Semester 2 (Jul-Des)</div>
                                    <div class="stat-value">${config.semester2 || 0}%</div>
                                    <small>${(config.semester2 / 6).toFixed(2)}% per bulan</small>
                                </div>
                            </div>
                        `;
                        break;
                        
                    case 'custom':
                        html += `
                            <div class="alert alert-info">
                                Pagu akan dibagi per bulan dengan persentase sebagai berikut (sama untuk semua jenis belanja):
                                <br><strong>Hasil alokasi per bulan akan berupa bilangan bulat tanpa desimal.</strong>
                            </div>
                            <div class="custom-month-inputs">
                                ${BULAN_INDONESIA.map((bulan, index) => {
                                    const percent = config[index + 1] || 0;
                                    return `
                                        <div class="form-group">
                                            <label>${bulan}:</label>
                                            <div class="form-control">${percent}%</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                        break;
                        
                    case 'per-kelompok':
                        // Validasi dulu sebelum preview
                        if (!this.validateAllGroups()) {
                            this.showAlert('Masih ada jenis belanja yang total persentasenya tidak 100%. Silakan periksa kembali.', 'warning');
                            return;
                        }
                        
                        appState.groupConfig = this.getGroupConfigFromUI();
                        const groupSummary = this.fileProcessor.analyzeGroupSummary(appState.uploadedData);
                        
                        html += `
                            <div class="alert alert-info">
                                Pagu akan dibagi per bulan dengan konfigurasi berbeda untuk setiap jenis belanja.
                                Total ${groupSummary.totalGroups} jenis belanja akan diproses.
                                <br><strong>Hasil alokasi per bulan akan berupa bilangan bulat tanpa desimal.</strong>
                            </div>
                            <h4>Ringkasan Jenis Belanja:</h4>
                            <div class="data-table-container">
                                <table class="opd-table">
                                    <thead>
                                        <tr>
                                            <th>Kode Jenis Belanja</th>
                                            <th>Nama Jenis Belanja</th>
                                            <th class="text-right">Jumlah Item</th>
                                            <th class="text-right">Total Pagu</th>
                                            <th class="text-right">Status Konfigurasi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        groupSummary.groupDetails.forEach(group => {
                            const groupConfig = appState.groupConfig[group.code];
                            const isValid = groupConfig && Math.abs(groupConfig.reduce((a, b) => a + b, 0) - 100) < 0.01;
                            
                            html += `
                                <tr>
                                    <td><strong>${group.code}</strong></td>
                                    <td>${group.name}</td>
                                    <td class="text-right">${group.itemCount}</td>
                                    <td class="text-right">${formatNumberExact(group.totalPagu)}</td>
                                    <td class="text-right">
                                        ${isValid ? 
                                            '<span style="color: green; font-weight: bold;">‚úì Valid</span>' : 
                                            '<span style="color: red; font-weight: bold;">‚úó Tidak Valid</span>'}
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                        break;
                }
                
                container.innerHTML = html;
            }
            
            getConfigFromUI() {
                const mode = appState.selectedMode;
                let config = {};
                
                switch (mode) {
                    case 'monthly':
                        config.numMonths = parseInt(document.getElementById('numMonths').value) || 12;
                        config.startMonth = parseInt(document.getElementById('startMonth').value) || 0;
                        break;
                        
                    case 'quarterly':
                        config.q1 = parseFloat(document.getElementById('q1Percent').value) || 25;
                        config.q2 = parseFloat(document.getElementById('q2Percent').value) || 25;
                        config.q3 = parseFloat(document.getElementById('q3Percent').value) || 25;
                        config.q4 = parseFloat(document.getElementById('q4Percent').value) || 25;
                        break;
                        
                    case 'semester':
                        config.semester1 = parseFloat(document.getElementById('s1Percent').value) || 50;
                        config.semester2 = parseFloat(document.getElementById('s2Percent').value) || 50;
                        break;
                        
                    case 'custom':
                        document.querySelectorAll('.month-percent').forEach(input => {
                            const month = parseInt(input.getAttribute('data-month'));
                            config[month] = parseFloat(input.value) || 0;
                        });
                        break;
                        
                    case 'per-kelompok':
                        config = this.getGroupConfigFromUI();
                        break;
                }
                
                return config;
            }
            
            getTotalPagu() {
                return appState.uploadedData.reduce((sum, item) => sum + (item.PAGU || 0), 0);
            }
            
            async processData() {
                try {
                    const mode = appState.selectedMode;
                    
                    // Validasi berdasarkan mode
                    if (mode === 'per-kelompok') {
                        if (!this.validateAllGroups()) {
                            this.showAlert('Masih ada jenis belanja yang total persentasenya tidak 100%. Silakan periksa kembali.', 'warning');
                            return;
                        }
                        appState.groupConfig = this.getGroupConfigFromUI();
                    } else if (mode !== 'monthly' && !this.validatePercentages(mode)) {
                        this.showAlert('Total persentase harus 100%', 'warning');
                        return;
                    }
                    
                    this.showLoading(true);
                    
                    const config = this.getConfigFromUI();
                    const data = appState.uploadedData;
                    
                    // Apply distribution
                    if (mode === 'per-kelompok') {
                        appState.processedData = this.fileProcessor.applyDistribution(data, mode, {}, appState.groupConfig);
                    } else {
                        appState.processedData = this.fileProcessor.applyDistribution(data, mode, config);
                    }
                    
                    // Validasi bahwa total alokasi = total pagu
                    const validation = this.fileProcessor.validateAllocation(appState.processedData);
                    
                    if (!validation.isValid) {
                        this.showAlert(`Peringatan: Selisih ditemukan antara pagu dan alokasi: ${validation.difference}`, 'warning');
                    }
                    
                    // Calculate monthly totals
                    appState.monthlyTotals = new Array(12).fill(0);
                    appState.groupMonthlyTotals = {};
                    
                    appState.processedData.forEach(item => {
                        item.allocations.forEach((amount, index) => {
                            appState.monthlyTotals[index] += amount;
                            
                            // Hitung juga total per jenis belanja
                            const groupCode = item.JENIS_BELANJA || 'Tidak Diketahui';
                            if (!appState.groupMonthlyTotals[groupCode]) {
                                appState.groupMonthlyTotals[groupCode] = new Array(12).fill(0);
                            }
                            appState.groupMonthlyTotals[groupCode][index] += amount;
                        });
                    });
                    
                    // Hitung UP (dengan pembulatan ribuan)
                    appState.upSummary = this.fileProcessor.calculateUP(appState.processedData);
                    
                    // Hitung per OPD per Jenis Belanja
                    appState.opdJenisSummary = this.fileProcessor.analyzeOpdJenisSummary(appState.processedData);
                    
                    // Move to results step
                    this.goToStep(5);
                    
                    // Display results
                    this.displayResults();
                    
                    if (validation.isValid) {
                        this.showAlert('Pembagian pagu berhasil diproses. Total alokasi sama persis dengan total pagu (selisih = 0).', 'success');
                    } else {
                        this.showAlert(`Pembagian pagu berhasil diproses dengan selisih ${validation.difference}.`, 'warning');
                    }
                    
                } catch (error) {
                    console.error('Process error:', error);
                    this.showAlert('Error memproses data: ' + error.message, 'warning');
                } finally {
                    this.showLoading(false);
                }
            }
            
            displayResults() {
                const totalPagu = this.getTotalPagu();
                const totalAllocated = appState.processedData.reduce((sum, item) => sum + item.totalAllocated, 0);
                const totalUP = appState.upSummary.reduce((sum, opd) => sum + opd.up, 0);
                const difference = totalAllocated - totalPagu;
                
                // Update summary cards
                document.getElementById('resultTotalPagu').textContent = formatNumberExact(totalPagu);
                document.getElementById('resultTotalAllocated').textContent = formatInteger(totalAllocated);
                document.getElementById('resultDifference').textContent = formatInteger(difference);
                document.getElementById('resultItemCount').textContent = appState.processedData.length.toLocaleString('id-ID');
                document.getElementById('resultMode').textContent = this.getModeName(appState.selectedMode);
                document.getElementById('resultTotalUP').textContent = formatRoundedNumber(totalUP);
                
                // Tampilkan warna berdasarkan selisih
                const diffElement = document.getElementById('resultDifference');
                if (difference === 0) {
                    diffElement.style.color = 'green';
                } else {
                    diffElement.style.color = 'red';
                }
                
                // Display monthly table
                this.displayMonthlyTable();
                
                // Display group summary
                this.displayGroupSummary();
                
                // Display UP summary
                this.displayUPSummary();
                
                // Display per OPD per Jenis Belanja
                this.displayOpdJenisSummary();
                
                // Display data table (first 100 rows)
                this.displayDataTable();
                
                // Create chart
                this.createChart();
                
                // Display summary
                this.displaySummary();
            }
            
            displayMonthlyTable() {
                const tbody = document.getElementById('monthlyTableBody');
                tbody.innerHTML = '';
                
                const totalAllocated = appState.monthlyTotals.reduce((sum, val) => sum + val, 0);
                const totalPagu = this.getTotalPagu();
                
                appState.monthlyTotals.forEach((amount, index) => {
                    const percentage = totalAllocated > 0 ? (amount / totalAllocated * 100).toFixed(2) : 0;
                    const percentageOfTotal = totalPagu > 0 ? (amount / totalPagu * 100).toFixed(2) : 0;
                    
                    const row = document.createElement('tr');
                    
                    const cells = [
                        BULAN_INDONESIA[index],
                        `${formatInteger(amount)}`,
                        `${percentage}%`,
                        `${percentageOfTotal}%`
                    ];
                    
                    cells.forEach((cellContent, cellIndex) => {
                        const cell = document.createElement('td');
                        cell.textContent = cellContent;
                        if (cellIndex > 0) cell.className = 'text-right';
                        row.appendChild(cell);
                    });
                    
                    tbody.appendChild(row);
                });
                
                // Add total row
                const totalRow = document.createElement('tr');
                totalRow.className = 'total-row';
                
                const totalCells = [
                    'TOTAL',
                    `${formatInteger(totalAllocated)}`,
                    '100%',
                    totalPagu > 0 ? `${(totalAllocated / totalPagu * 100).toFixed(2)}%` : '0%'
                ];
                
                totalCells.forEach((cellContent, cellIndex) => {
                    const cell = document.createElement('td');
                    cell.textContent = cellContent;
                    if (cellIndex > 0) cell.className = 'text-right';
                    cell.style.fontWeight = 'bold';
                    totalRow.appendChild(cell);
                });
                
                tbody.appendChild(totalRow);
            }
            
            displayGroupSummary() {
                const container = document.getElementById('groupSummaryTable');
                const groupSummary = this.fileProcessor.analyzeGroupSummary(appState.processedData);
                
                let html = `
                    <div class="alert alert-info">
                        <strong>Ringkasan Distribusi Per Jenis Belanja:</strong> Total ${groupSummary.totalGroups} jenis belanja
                        <br><small>Catatan: Hasil alokasi per bulan berupa bilangan bulat tanpa desimal</small>
                    </div>
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Kode Jenis Belanja</th>
                                    <th>Nama Jenis Belanja</th>
                                    <th class="text-right">Jumlah Item</th>
                                    <th class="text-right">Total Pagu</th>
                                    ${BULAN_SINGKAT.map(bulan => `<th class="text-right">${bulan}</th>`).join('')}
                                    <th class="text-right">Total Dialokasikan</th>
                                    <th class="text-right">% dari Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                groupSummary.groupDetails.forEach(group => {
                    const groupCode = group.code;
                    const groupTotals = appState.groupMonthlyTotals[groupCode] || new Array(12).fill(0);
                    const totalGroupAllocated = groupTotals.reduce((sum, val) => sum + val, 0);
                    const percentageOfTotal = this.getTotalPagu() > 0 ? (totalGroupAllocated / this.getTotalPagu() * 100).toFixed(2) : 0;
                    
                    html += `
                        <tr>
                            <td><strong>${groupCode}</strong></td>
                            <td>${group.name}</td>
                            <td class="text-right">${group.itemCount}</td>
                            <td class="text-right">${formatNumberExact(group.totalPagu)}</td>
                    `;
                    
                    // Data per bulan
                    groupTotals.forEach(amount => {
                        html += `<td class="text-right">${formatInteger(amount)}</td>`;
                    });
                    
                    html += `
                            <td class="text-right">${formatInteger(totalGroupAllocated)}</td>
                            <td class="text-right">${percentageOfTotal}%</td>
                        </tr>
                    `;
                });
                
                // Total row
                const totalAllocated = appState.monthlyTotals.reduce((sum, val) => sum + val, 0);
                html += `
                            <tfoot>
                                <tr style="background-color: #f8f9fa; font-weight: bold;">
                                    <td colspan="3">TOTAL</td>
                                    <td class="text-right">${formatNumberExact(this.getTotalPagu())}</td>
                `;
                
                appState.monthlyTotals.forEach(amount => {
                    html += `<td class="text-right">${formatInteger(amount)}</td>`;
                });
                
                html += `
                                    <td class="text-right">${formatInteger(totalAllocated)}</td>
                                    <td class="text-right">100%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                
                container.innerHTML = html;
            }
            
            displayUPSummary() {
                if (!appState.upSummary) return;
                
                const upSummary = appState.upSummary;
                const totalUP = upSummary.reduce((sum, opd) => sum + opd.up, 0);
                
                let html = `
                    <div class="alert alert-info">
                        <strong>Ringkasan Uang Persediaan (UP) per OPD/SKPD:</strong><br>
                        UP dihitung sebesar 10% dari total Belanja Barang dan Jasa (Jenis ${KODE_BELANJA_BARANG_JASA}) masing-masing OPD
                        <br><small>Catatan: UP sudah dibulatkan ke ribuan terdekat</small>
                    </div>
                    
                    <div class="summary-cards">
                        <div class="result-card">
                            <div class="result-title">Total OPD/SKPD</div>
                            <div class="result-value">${upSummary.length}</div>
                        </div>
                        <div class="result-card">
                            <div class="result-title">Total UP</div>
                            <div class="result-value">${formatRoundedNumber(totalUP)}</div>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>OPD/SKPD</th>
                                    <th class="text-right">Total Pagu</th>
                                    <th class="text-right">Total Belanja Barang & Jasa</th>
                                    <th class="text-right">UP (10%)</th>
                                    <th class="text-right">% dari Total Pagu</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Sort by UP descending
                const sortedSummary = [...upSummary].sort((a, b) => b.up - a.up);
                const totalPaguAll = sortedSummary.reduce((sum, opd) => sum + opd.totalPagu, 0);
                
                sortedSummary.forEach((opd, index) => {
                    const percentage = totalPaguAll > 0 ? ((opd.totalPagu / totalPaguAll) * 100).toFixed(2) : 0;
                    
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${opd.name}</strong></td>
                            <td class="text-right">${formatNumberExact(opd.totalPagu)}</td>
                            <td class="text-right">${formatNumberExact(opd.totalBelanjaBarangJasa)}</td>
                            <td class="text-right" style="color: #1a2980; font-weight: bold;">${formatRoundedNumber(opd.up)}</td>
                            <td class="text-right">${percentage}%</td>
                        </tr>
                    `;
                });
                
                // Total row
                html += `
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #f8f9fa; font-weight: bold;">
                                <td colspan="2">TOTAL</td>
                                <td class="text-right">${formatNumberExact(totalPaguAll)}</td>
                                <td class="text-right">${formatNumberExact(sortedSummary.reduce((sum, opd) => sum + opd.totalBelanjaBarangJasa, 0))}</td>
                                <td class="text-right" style="color: #1a2980;">${formatRoundedNumber(totalUP)}</td>
                                <td class="text-right">100%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                `;
                
                document.getElementById('upSummaryTable').innerHTML = html;
            }
            
            displayOpdJenisSummary() {
                if (!appState.opdJenisSummary) return;
                
                const opdJenisSummary = appState.opdJenisSummary;
                
                let html = `
                    <div class="alert alert-info">
                        <strong>Ringkasan per OPD per Jenis Belanja:</strong> Menampilkan total pagu per jenis belanja di setiap OPD/SKPD
                        <br><small>Catatan: Pagu ditampilkan tanpa pembulatan, sesuai data asli</small>
                    </div>
                    
                    <div class="summary-cards">
                        <div class="result-card">
                            <div class="result-title">Total OPD/SKPD</div>
                            <div class="result-value">${opdJenisSummary.length}</div>
                        </div>
                        <div class="result-card">
                            <div class="result-title">Total Pagu</div>
                            <div class="result-value">${formatNumberExact(opdJenisSummary.reduce((sum, opd) => sum + opd.totalPagu, 0))}</div>
                        </div>
                    </div>
                `;
                
                // Untuk setiap OPD, buat tabel
                opdJenisSummary.forEach((opd, opdIndex) => {
                    html += `
                        <h4>${opd.name}</h4>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Kode Jenis Belanja</th>
                                        <th>Nama Jenis Belanja</th>
                                        <th class="text-right">Jumlah Item</th>
                                        <th class="text-right">Total Pagu</th>
                                        <th class="text-right">% dari OPD</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    opd.jenisBelanja.forEach((jenis, jenisIndex) => {
                        const percentage = opd.totalPagu > 0 ? ((jenis.totalPagu / opd.totalPagu) * 100).toFixed(2) : 0;
                        
                        html += `
                            <tr>
                                <td>${jenisIndex + 1}</td>
                                <td><strong>${jenis.code}</strong></td>
                                <td>${jenis.name}</td>
                                <td class="text-right">${jenis.itemCount}</td>
                                <td class="text-right">${formatNumberExact(jenis.totalPagu)}</td>
                                <td class="text-right">${percentage}%</td>
                            </tr>
                        `;
                    });
                    
                    // Total row untuk OPD
                    html += `
                                </tbody>
                                <tfoot>
                                    <tr style="background-color: #f8f9fa; font-weight: bold;">
                                        <td colspan="3">TOTAL ${opd.name}</td>
                                        <td class="text-right">${opd.totalItem}</td>
                                        <td class="text-right">${formatNumberExact(opd.totalPagu)}</td>
                                        <td class="text-right">100%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                });
                
                document.getElementById('opdJenisTable').innerHTML = html;
            }
            
            displayDataTable() {
                const thead = document.getElementById('resultTableHead');
                const tbody = document.getElementById('resultTableBody');
                
                thead.innerHTML = '';
                tbody.innerHTML = '';
                
                // Create header row
                const headerRow = document.createElement('tr');
                
                // Tambahkan semua kolom asli dari STANDARD_COLUMNS
                const displayColumns = [...STANDARD_COLUMNS, 'JENIS_BELANJA'];
                
                displayColumns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    if (col === 'PAGU') {
                        th.className = 'text-right';
                    }
                    headerRow.appendChild(th);
                });
                
                // Tambahkan header untuk bulan
                BULAN_SINGKAT.forEach(bulan => {
                    const th = document.createElement('th');
                    th.textContent = bulan;
                    th.className = 'text-right';
                    headerRow.appendChild(th);
                });
                
                // Tambahkan header untuk total dialokasikan
                const thTotal = document.createElement('th');
                thTotal.textContent = 'TOTAL DIALOKASIKAN';
                thTotal.className = 'text-right';
                headerRow.appendChild(thTotal);
                
                thead.appendChild(headerRow);
                
                // Show first 100 rows
                const displayData = appState.processedData.slice(0, 100);
                
                displayData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    
                    // Kolom asli dari file upload
                    displayColumns.forEach(col => {
                        let value = item[col] !== undefined ? item[col] : '';
                        
                        // Format khusus untuk PAGU (tanpa pembulatan)
                        if (col === 'PAGU') {
                            value = formatNumberExact(value);
                        }
                        
                        // Format jenis belanja
                        if (col === 'JENIS_BELANJA' && value) {
                            value = getGroupName(value) || value;
                        }
                        
                        const cell = document.createElement('td');
                        cell.textContent = value;
                        
                        if (col === 'PAGU' || col === 'JENIS_BELANJA') {
                            cell.className = 'text-right';
                        }
                        
                        row.appendChild(cell);
                    });
                    
                    // Kolom bulan (12 bulan) - tampilkan sebagai integer
                    item.allocations.forEach(amount => {
                        const cell = document.createElement('td');
                        cell.textContent = formatInteger(amount);
                        cell.className = 'text-right';
                        row.appendChild(cell);
                    });
                    
                    // Kolom total dialokasikan - tampilkan sebagai integer
                    const totalCell = document.createElement('td');
                    totalCell.textContent = formatInteger(item.totalAllocated);
                    totalCell.className = 'text-right';
                    row.appendChild(totalCell);
                    
                    tbody.appendChild(row);
                });
                
                // Add note if there are more rows
                if (appState.processedData.length > 100) {
                    const noteRow = document.createElement('tr');
                    const noteCell = document.createElement('td');
                    noteCell.colSpan = displayColumns.length + 12 + 1; // 12 bulan + 1 total
                    noteCell.textContent = `... dan ${appState.processedData.length - 100} baris lainnya (total: ${appState.processedData.length} baris)`;
                    noteCell.className = 'text-center';
                    noteCell.style.color = '#666';
                    noteRow.appendChild(noteCell);
                    tbody.appendChild(noteRow);
                }
            }
            
            displaySummary() {
                const container = document.getElementById('summaryTable');
                const totalPagu = this.getTotalPagu();
                const totalAllocated = appState.monthlyTotals.reduce((sum, val) => sum + val, 0);
                const totalUP = appState.upSummary ? appState.upSummary.reduce((sum, opd) => sum + opd.up, 0) : 0;
                const difference = totalAllocated - totalPagu;
                
                let html = `
                    <div class="alert ${difference === 0 ? 'alert-success' : 'alert-warning'}">
                        <h4>Ringkasan Hasil</h4>
                        <p>Total pagu berhasil dialokasikan ke semua bulan dengan pola ${this.getModeName(appState.selectedMode)}.</p>
                        <p><strong>Selisih antara total pagu dan total alokasi: ${formatInteger(difference)}</strong></p>
                        <p>${difference === 0 ? 
                            '‚úì Total alokasi sama persis dengan total pagu (selisih = 0)' : 
                            '‚ö†Ô∏è Ada selisih antara total pagu dan total alokasi'}
                        </p>
                    </div>
                    
                    <div class="stats-summary">
                        <div class="stat-card">
                            <div class="stat-label">Total Pagu Asli</div>
                            <div class="stat-value">${formatNumberExact(totalPagu)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Setelah Dialokasi</div>
                            <div class="stat-value">${formatInteger(totalAllocated)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Selisih (Pembulatan)</div>
                            <div class="stat-value" style="${difference === 0 ? 'color: green;' : 'color: red;'}">${formatInteger(difference)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Persentase Selisih</div>
                            <div class="stat-value">${totalPagu > 0 ? ((Math.abs(difference) / totalPagu * 100).toFixed(4)) : 0}%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total UP (10%)</div>
                            <div class="result-value" style="color: #1a2980;">${formatRoundedNumber(totalUP)}</div>
                        </div>
                    </div>
                    
                    <h4>Distribusi per Bulan:</h4>
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Bulan</th>
                                    <th class="text-right">Alokasi</th>
                                    <th class="text-right">% dari Total</th>
                                    <th class="text-right">Ranking</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Sort months by allocation
                const monthRanking = appState.monthlyTotals
                    .map((amount, index) => ({ month: index, amount }))
                    .sort((a, b) => b.amount - a.amount);
                
                monthRanking.forEach((item, index) => {
                    const percentage = totalAllocated > 0 ? (item.amount / totalAllocated * 100).toFixed(2) : 0;
                    
                    html += `
                        <tr>
                            <td>${BULAN_INDONESIA[item.month]}</td>
                            <td class="text-right">${formatInteger(item.amount)}</td>
                            <td class="text-right">${percentage}%</td>
                            <td class="text-right">${index + 1}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.innerHTML = html;
            }
            
            createChart() {
                const ctx = document.getElementById('allocationChart');
                if (!ctx) return;
                
                // Destroy existing chart
                if (appState.chart) {
                    appState.chart.destroy();
                }
                
                // Prepare data for chart
                const labels = BULAN_SINGKAT;
                const data = appState.monthlyTotals;
                
                // Create gradient
                const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(26, 41, 128, 0.8)');
                gradient.addColorStop(1, 'rgba(38, 208, 206, 0.2)');
                
                appState.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Alokasi per Bulan',
                            data: data,
                            backgroundColor: gradient,
                            borderColor: 'rgba(26, 41, 128, 1)',
                            borderWidth: 1,
                            borderRadius: 5,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = context.parsed.y;
                                        return `${formatInteger(value)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => {
                                        return formatInteger(value);
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Jumlah (bilangan bulat)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Bulan'
                                }
                            }
                        }
                    }
                });
            }
            
            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const tabBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
                if (tabBtn) {
                    tabBtn.classList.add('active');
                }
                
                // Show tab content
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active');
                });
                
                const tabContent = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
                if (tabContent) {
                    tabContent.classList.add('active');
                }
            }
            
            downloadExcel() {
                try {
                    if (!appState.processedData) {
                        throw new Error('Tidak ada data untuk diunduh');
                    }
                    
                    // Prepare data for Excel
                    const headers = [...STANDARD_COLUMNS, 'JENIS_BELANJA'];
                    
                    // Add month columns
                    BULAN_INDONESIA.forEach(bulan => {
                        headers.push(bulan);
                    });
                    
                    headers.push('TOTAL DIALOKASIKAN');
                    
                    const data = [headers];
                    
                    // Add data rows
                    appState.processedData.forEach((item, index) => {
                        const row = [];
                        
                        // Add standard columns
                        STANDARD_COLUMNS.forEach(col => {
                            let value = item[col] !== undefined ? item[col] : '';
                            // Convert to number if it's PAGU
                            if (col === 'PAGU') {
                                value = parseFloat(value) || 0;
                            }
                            row.push(value);
                        });
                        
                        // Add jenis belanja
                        row.push(item.JENIS_BELANJA || '');
                        
                        // Add monthly allocations (bilangan bulat)
                        item.allocations.forEach(amount => {
                            row.push(amount); // Sudah bilangan bulat
                        });
                        
                        row.push(item.totalAllocated || 0);
                        
                        data.push(row);
                    });
                    
                    // Add summary sheet
                    const summaryData = [
                        ['RINGKASAN PEMBAGIAN PAGU'],
                        ['Dikembangkan oleh: Hendra, Bidang Perbendaharaan BPKAD Kabupaten Mamuju'],
                        ['Tanggal Generate', new Date().toLocaleDateString('id-ID')],
                        ['Waktu Generate', new Date().toLocaleTimeString('id-ID')],
                        ['Jumlah Data', appState.processedData.length],
                        ['Total Pagu', this.getTotalPagu()],
                        ['Total Dialokasikan', appState.monthlyTotals.reduce((a, b) => a + b, 0)],
                        ['Selisih', appState.monthlyTotals.reduce((a, b) => a + b, 0) - this.getTotalPagu()],
                        ['Pola Distribusi', this.getModeName(appState.selectedMode)],
                        ['Catatan', 'Alokasi per bulan berupa bilangan bulat tanpa desimal'],
                        [''],
                        ['ALOKASI PER BULAN'],
                        ['Bulan', 'Alokasi', 'Persentase']
                    ];
                    
                    const totalAllocated = appState.monthlyTotals.reduce((a, b) => a + b, 0);
                    appState.monthlyTotals.forEach((amount, index) => {
                        const percentage = totalAllocated > 0 ? (amount / totalAllocated * 100).toFixed(2) : 0;
                        summaryData.push([BULAN_INDONESIA[index], amount, `${percentage}%`]);
                    });
                    
                    // Add UP summary sheet
                    const upSummary = appState.upSummary;
                    const upData = [
                        ['RINGKASAN UANG PERSEDIAAN (UP) PER OPD/SKPD'],
                        ['Catatan: UP dihitung 10% dari total Belanja Barang dan Jasa (Jenis 5.1.02)'],
                        ['UP telah dibulatkan ke ribuan terdekat'],
                        [''],
                        ['No', 'OPD/SKPD', 'Total Pagu', 'Total Belanja Barang & Jasa', 'UP (10%)', '% dari Total']
                    ];
                    
                    const sortedUPSummary = [...upSummary].sort((a, b) => b.up - a.up);
                    const totalPaguAll = sortedUPSummary.reduce((sum, opd) => sum + opd.totalPagu, 0);
                    
                    sortedUPSummary.forEach((opd, index) => {
                        const percentage = totalPaguAll > 0 ? ((opd.totalPagu / totalPaguAll) * 100).toFixed(2) : 0;
                        upData.push([
                            index + 1,
                            opd.name,
                            opd.totalPagu,
                            opd.totalBelanjaBarangJasa,
                            roundToThousands(opd.up), // UP dibulatkan ke ribuan
                            `${percentage}%`
                        ]);
                    });
                    
                    // Add total row
                    upData.push([
                        'TOTAL',
                        '',
                        sortedUPSummary.reduce((sum, opd) => sum + opd.totalPagu, 0),
                        sortedUPSummary.reduce((sum, opd) => sum + opd.totalBelanjaBarangJasa, 0),
                        roundToThousands(sortedUPSummary.reduce((sum, opd) => sum + opd.up, 0)),
                        '100%'
                    ]);
                    
                    // Add OPD per Jenis Belanja sheet
                    const opdJenisData = [
                        ['RINGKASAN PER OPD PER JENIS BELANJA'],
                        ['Catatan: Pagu ditampilkan tanpa pembulatan'],
                        [''],
                        ['OPD/SKPD', 'Kode Jenis Belanja', 'Nama Jenis Belanja', 'Jumlah Item', 'Total Pagu']
                    ];
                    
                    appState.opdJenisSummary.forEach(opd => {
                        opd.jenisBelanja.forEach(jenis => {
                            opdJenisData.push([
                                opd.name,
                                jenis.code,
                                jenis.name,
                                jenis.itemCount,
                                jenis.totalPagu
                            ]);
                        });
                    });
                    
                    // Add group summary sheet
                    const groupSummary = this.fileProcessor.analyzeGroupSummary(appState.processedData);
                    const groupData = [
                        ['RINGKASAN PER JENIS BELANJA'],
                        ['Catatan: Alokasi per bulan berupa bilangan bulat tanpa desimal'],
                        [''],
                        ['Kode', 'Nama Jenis Belanja', 'Jumlah Item', 'Total Pagu', ...BULAN_INDONESIA, 'Total Dialokasikan']
                    ];
                    
                    groupSummary.groupDetails.forEach(group => {
                        const groupCode = group.code;
                        const groupTotals = appState.groupMonthlyTotals[groupCode] || new Array(12).fill(0);
                        const totalGroupAllocated = groupTotals.reduce((sum, val) => sum + val, 0);
                        
                        const row = [
                            groupCode,
                            group.name,
                            group.itemCount,
                            group.totalPagu,
                            ...groupTotals.map(amount => amount), // Sudah bilangan bulat
                            totalGroupAllocated
                        ];
                        
                        groupData.push(row);
                    });
                    
                    // Create workbook
                    const workbook = XLSX.utils.book_new();
                    
                    // Main data sheet
                    const worksheet = XLSX.utils.aoa_to_sheet(data);
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Data Anggaran');
                    
                    // Summary sheet
                    const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(workbook, summarySheet, 'Ringkasan');
                    
                    // UP sheet
                    const upSheet = XLSX.utils.aoa_to_sheet(upData);
                    XLSX.utils.book_append_sheet(workbook, upSheet, 'Ringkasan UP');
                    
                    // OPD per Jenis sheet
                    const opdJenisSheet = XLSX.utils.aoa_to_sheet(opdJenisData);
                    XLSX.utils.book_append_sheet(workbook, opdJenisSheet, 'OPD per Jenis Belanja');
                    
                    // Group sheet
                    const groupSheet = XLSX.utils.aoa_to_sheet(groupData);
                    XLSX.utils.book_append_sheet(workbook, groupSheet, 'Ringkasan Jenis Belanja');
                    
                    // Generate Excel file
                    const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([excelBuffer], { 
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });
                    
                    // Download
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const now = new Date();
                    const dateStr = now.toISOString().slice(0,10).replace(/-/g, '');
                    const timeStr = now.toTimeString().slice(0,8).replace(/:/g, '');
                    a.download = `Pembagian_Pagu_${dateStr}_${timeStr}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showAlert('File Excel berhasil diunduh!', 'success');
                    
                } catch (error) {
                    console.error('Download error:', error);
                    this.showAlert('Error mengunduh file: ' + error.message, 'warning');
                }
            }
            
            resetProcess() {
                // Reset state
                appState = {
                    uploadedData: null,
                    originalHeaders: [],
                    opdSummary: null,
                    selectedMode: 'monthly',
                    modeConfig: {},
                    groupConfig: {},
                    processedData: null,
                    monthlyTotals: new Array(12).fill(0),
                    groupMonthlyTotals: {},
                    chart: null,
                    upSummary: null,
                    opdJenisSummary: null
                };
                
                // Reset UI
                document.getElementById('rkaFile').value = '';
                document.getElementById('uploadStats').style.display = 'none';
                document.getElementById('modeConfigSection').style.display = 'none';
                document.getElementById('groupConfigSection').style.display = 'none';
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Reset review data
                document.getElementById('reviewStats').innerHTML = '';
                document.getElementById('opdSummary').innerHTML = '';
                
                // Go to step 1
                this.goToStep(1);
                
                this.showAlert('Siap untuk memulai proses baru', 'info');
            }
            
            // ===============================
            // 7. UTILITY FUNCTIONS
            // ===============================
            
            showAlert(message, type = 'info') {
                // Remove existing alerts
                document.querySelectorAll('.alert').forEach(alert => {
                    if (alert.parentElement && alert.parentElement.id === 'alerts-container') {
                        alert.remove();
                    }
                });
                
                // Create alert container if it doesn't exist
                let alertContainer = document.getElementById('alerts-container');
                if (!alertContainer) {
                    alertContainer = document.createElement('div');
                    alertContainer.id = 'alerts-container';
                    alertContainer.style.position = 'fixed';
                    alertContainer.style.top = '20px';
                    alertContainer.style.right = '20px';
                    alertContainer.style.zIndex = '1000';
                    document.body.appendChild(alertContainer);
                }
                
                // Create alert
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.style.marginBottom = '10px';
                alertDiv.style.padding = '15px';
                alertDiv.style.borderRadius = '8px';
                alertDiv.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
                alertDiv.style.maxWidth = '400px';
                alertDiv.innerHTML = message;
                
                alertContainer.appendChild(alertDiv);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentElement === alertContainer) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
            
            showLoading(show) {
                const processBtn = document.getElementById('btnProcess');
                if (processBtn) {
                    if (show) {
                        processBtn.disabled = true;
                        processBtn.innerHTML = '<span class="spinner"></span> Memproses...';
                    } else {
                        processBtn.disabled = false;
                        processBtn.innerHTML = 'Proses Pembagian Pagu';
                    }
                }
            }
        }
        
        // ===============================
        // 8. INITIALIZE APPLICATION
        // ===============================
        
        document.addEventListener('DOMContentLoaded', () => {
            const uiManager = new UIManager();
            
            // Make available globally for debugging
            window.app = {
                state: appState,
                ui: uiManager
            };
            
            console.log('Anggaran Kas Generator siap digunakan!');
            console.log('Dikembangkan oleh: Hendra, Bidang Perbendaharaan BPKAD Kabupaten Mamuju');
            console.log('Fitur: Pagu dan alokasi sama persis, alokasi per bulan bilangan bulat, UP dibulatkan ke ribuan');
        });
    </script>
</body>
</html>
