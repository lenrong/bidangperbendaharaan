<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CERMAT CLOUD - BPKAD Kabupaten Mamuju</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* MODERN DESIGN - TEMA TETAP SAMA TAPI LEBIH MODERN */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
            color: #1e293b;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .login-container {
            max-width: 500px;
            width: 100%;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(26, 41, 128, 0.15);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            padding: 35px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
        }
        
        .header h1 {
            font-size: 36px;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -0.5px;
            position: relative;
        }
        
        .header p {
            opacity: 0.95;
            font-size: 16px;
            font-weight: 300;
        }
        
        .content {
            padding: 40px;
        }
        
        .system-icon {
            font-size: 70px;
            text-align: center;
            margin-bottom: 25px;
            color: #1a2980;
            filter: drop-shadow(0 5px 15px rgba(26, 41, 128, 0.1));
        }
        
        .form-group {
            margin-bottom: 28px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #475569;
            font-size: 15px;
        }
        
        .form-control {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #f8fafc;
        }
        
        .form-control:focus {
            border-color: #1a2980;
            outline: none;
            box-shadow: 0 0 0 4px rgba(26, 41, 128, 0.1);
            background: white;
            transform: translateY(-2px);
        }
        
        .btn {
            width: 100%;
            padding: 17px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        
        .btn:hover::after {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 25px rgba(26, 41, 128, 0.25);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
            color: white;
            margin-top: 15px;
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(100, 116, 139, 0.2);
        }
        
        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            width: auto;
            padding: 15px 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border-radius: 12px;
        }
        
        .btn-whatsapp:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 25px rgba(37, 211, 102, 0.25);
        }
        
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 8px;
            display: none;
            background: #fef2f2;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
        }
        
        .login-info {
            text-align: center;
            margin-top: 25px;
            color: #64748b;
            font-size: 14px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        .request-access {
            text-align: center;
            margin: 35px 0 20px 0;
            padding-top: 25px;
            border-top: 2px dashed #e2e8f0;
        }
        
        .request-access p {
            color: #64748b;
            margin-bottom: 18px;
            font-size: 15px;
            font-weight: 500;
        }
        
        .footer {
            text-align: center;
            padding: 22px;
            background: #f8fafc;
            color: #64748b;
            font-size: 14px;
            border-top: 1px solid #e2e8f0;
        }
        
        /* MODERN DASHBOARD STYLES */
        .dashboard-container {
            max-width: 1400px;
            width: 100%;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(26, 41, 128, 0.15);
            overflow: hidden;
            min-height: 90vh;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            padding: 25px 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
        }
        
        .dashboard-header h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            position: relative;
        }
        
        .dashboard-header p {
            font-size: 15px;
            opacity: 0.95;
            margin-top: 5px;
        }
        
        .user-info {
            text-align: right;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .user-info p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 22px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .dashboard-nav {
            background: #f8fafc;
            padding: 18px 35px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            backdrop-filter: blur(10px);
        }
        
        .nav-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            color: #475569;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
        }
        
        .nav-btn:hover {
            background: #f1f5f9;
            border-color: #1a2980;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(26, 41, 128, 0.1);
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            border-color: #1a2980;
            box-shadow: 0 8px 20px rgba(26, 41, 128, 0.2);
        }
        
        .dashboard-content {
            padding: 35px;
            min-height: 500px;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* MODERN HOME TAB */
        .welcome-message {
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 35px;
            border-left: 6px solid #1a2980;
            box-shadow: 0 10px 25px rgba(26, 41, 128, 0.08);
        }
        
        .welcome-message h2 {
            color: #1a2980;
            margin-bottom: 12px;
            font-size: 28px;
            font-weight: 700;
        }
        
        .welcome-message p {
            color: #475569;
            font-size: 17px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1a2980, #26d0ce);
        }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(26, 41, 128, 0.15);
        }
        
        .stat-icon {
            font-size: 36px;
            color: #1a2980;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stat-title {
            font-size: 15px;
            color: #64748b;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1a2980;
        }
        
        .table-container {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
            border: 1px solid #e2e8f0;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
        }
        
        th, td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #f8fafc;
            font-weight: 600;
            color: #1a2980;
            position: sticky;
            top: 0;
            font-size: 15px;
            border-top: 1px solid #e2e8f0;
            border-bottom: 2px solid #1a2980;
        }
        
        tr:hover {
            background: #f1f5f9;
        }
        
        .badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .badge-info {
            background: #e0f2fe;
            color: #075985;
            border: 1px solid #bae6fd;
        }
        
        .view-detail-btn {
            padding: 8px 18px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            color: #475569;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }
        
        .view-detail-btn:hover {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            border-color: #1a2980;
            transform: translateY(-2px);
        }
        
        /* MODERN MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(30px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
            padding: 30px 35px 20px;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 20px 20px 0 0;
        }
        
        .modal-title {
            font-size: 24px;
            color: #1a2980;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal-title i {
            font-size: 26px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #64748b;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            background: #f1f5f9;
            color: #1a2980;
            transform: rotate(90deg);
        }
        
        /* MODERN MODAL BODY - DESAIN BARU */
        .modal-body {
            padding: 30px 35px;
        }
        
        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .modal-section {
            background: white;
            border-radius: 16px;
            padding: 0;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.03);
            transition: transform 0.3s ease;
        }
        
        .modal-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        
        .modal-section-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal-section-header i {
            font-size: 22px;
            color: #1a2980;
        }
        
        .modal-section-header h4 {
            color: #1a2980;
            margin: 0;
            font-size: 18px;
            font-weight: 700;
        }
        
        .modal-section-content {
            padding: 20px;
        }
        
        .detail-group {
            margin-bottom: 20px;
        }
        
        .detail-group:last-child {
            margin-bottom: 0;
        }
        
        .detail-label {
            display: block;
            font-size: 13px;
            color: #64748b;
            margin-bottom: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            font-size: 16px;
            color: #1e293b;
            font-weight: 600;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            word-break: break-word;
        }
        
        .detail-value.amount {
            color: #1a2980;
            font-size: 18px;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
            border-color: #c7d2fe;
        }
        
        .detail-value.status-success {
            background: #dcfce7;
            color: #166534;
            border-color: #bbf7d0;
        }
        
        .detail-value.status-warning {
            background: #fef3c7;
            color: #92400e;
            border-color: #fde68a;
        }
        
        .detail-value.status-info {
            background: #e0f2fe;
            color: #075985;
            border-color: #bae6fd;
        }
        
        .sumber-dana-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .sumber-dana-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }
        
        .sumber-dana-card:hover {
            border-color: #1a2980;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(26, 41, 128, 0.1);
        }
        
        .sumber-dana-label {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .sumber-dana-value {
            font-size: 18px;
            color: #1a2980;
            font-weight: 700;
        }
        
        .modal-footer {
            padding: 20px 35px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 0 0 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .transaction-id {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
        }
        
        .modal-btn {
            padding: 10px 22px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid;
            font-size: 14px;
        }
        
        .modal-btn-print {
            background: white;
            color: #475569;
            border-color: #cbd5e1;
        }
        
        .modal-btn-print:hover {
            background: #f1f5f9;
            border-color: #94a3b8;
        }
        
        .modal-btn-close {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            border: none;
        }
        
        .modal-btn-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(26, 41, 128, 0.2);
        }
        
        /* Request Modal Styles */
        .request-modal .modal-content {
            max-width: 550px;
        }
        
        .request-instruction {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #1a2980;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        
        .request-instruction ol {
            margin-left: 20px;
            margin-top: 12px;
        }
        
        .request-instruction li {
            margin-bottom: 8px;
            color: #475569;
            line-height: 1.6;
        }
        
        /* Chart Styles */
        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }
        
        /* Filter Styles */
        .filter-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-input {
            padding: 12px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            min-width: 220px;
            font-size: 15px;
            transition: all 0.3s;
            background: #f8fafc;
        }
        
        .filter-input:focus {
            border-color: #1a2980;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 41, 128, 0.1);
            background: white;
        }
        
        .filter-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(26, 41, 128, 0.2);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 25px;
        }
        
        .page-btn {
            padding: 10px 18px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .page-btn:hover:not(.active):not(:disabled) {
            border-color: #1a2980;
            transform: translateY(-2px);
        }
        
        .page-btn.active {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            border-color: #1a2980;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #64748b;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 60px;
            height: 60px;
            border: 3px solid #f1f5f9;
            border-top: 3px solid #1a2980;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .access-info {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
            border: 1px solid #fde68a;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-size: 15px;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        
        .card-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            color: #1a2980;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 15px;
        }
        
        .card-btn:hover {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            border-color: #1a2980;
            transform: translateY(-3px);
        }
        
        .warning-alert {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fde68a;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-size: 15px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            color: #92400e;
        }
        
        .warning-alert i {
            font-size: 22px;
            color: #f59e0b;
        }
        
        .success-alert {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 1px solid #bbf7d0;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-size: 15px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            color: #166534;
        }
        
        .success-alert i {
            font-size: 22px;
            color: #22c55e;
        }
        
        .export-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.25);
        }
        
        .export-btn.export-excel {
            background: linear-gradient(135deg, #1d6f42 0%, #14532d 100%);
        }
        
        .export-btn.export-excel:hover {
            box-shadow: 0 10px 25px rgba(21, 83, 45, 0.25);
        }
        
        /* Styles khusus untuk tabel Realisasi Sumber Dana per SKPD */
        .sumber-dana-table-container {
            margin-top: 20px;
        }
        
        .sumber-dana-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .sumber-dana-table th {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            font-weight: 600;
            padding: 16px 20px;
            text-align: left;
            font-size: 15px;
        }
        
        .sumber-dana-table td {
            padding: 14px 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .sumber-dana-table tr:nth-child(even) {
            background: #f8fafc;
        }
        
        .sumber-dana-table tr:hover {
            background: #f1f5f9;
        }
        
        .sumber-dana-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
            border-radius: 16px;
            border-left: 4px solid #1a2980;
        }
        
        .summary-item {
            text-align: center;
            flex: 1;
        }
        
        .summary-label {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .summary-value {
            font-size: 22px;
            font-weight: 700;
            color: #1a2980;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
                padding: 25px 20px;
            }
            
            .user-info {
                text-align: center;
                width: 100%;
            }
            
            .dashboard-nav {
                padding: 15px 20px;
                justify-content: center;
            }
            
            .nav-btn {
                font-size: 14px;
                padding: 10px 18px;
            }
            
            .dashboard-content {
                padding: 25px 20px;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-body {
                padding: 25px 20px;
            }
            
            .modal-header {
                padding: 25px 20px 20px;
            }
            
            .modal-footer {
                padding: 20px;
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-input {
                width: 100%;
            }
            
            .btn-whatsapp {
                width: 100%;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .sumber-dana-table {
                font-size: 14px;
            }
            
            .sumber-dana-table th,
            .sumber-dana-table td {
                padding: 12px 15px;
            }
            
            .sumber-dana-summary {
                flex-direction: column;
                gap: 20px;
            }
            
            .sumber-dana-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .content {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 28px;
            }
            
            .modal-title {
                font-size: 20px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-value {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen (default) -->
    <div class="login-container" id="loginScreen">
        <div class="header">
            <h1>CERMAT CLOUD</h1>
            <p>Cek dan Rekonsiliasi Manajemen Transaksi Berbasis Cloud</p>
        </div>
        
        <div class="content">
            <div class="system-icon">☁️</div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="nama">Nama Pengguna</label>
                    <input type="text" id="nama" class="form-control" placeholder="Masukkan nama Anda" required>
                </div>
                
                <div class="form-group">
                    <label for="kodeAkses">Kode Akses</label>
                    <input type="password" id="kodeAkses" class="form-control" placeholder="Masukkan kode akses" required>
                </div>
                
                <div class="error-message" id="errorMessage">
                    Kode akses salah. Silakan coba lagi.
                </div>
                
                <button type="submit" class="btn btn-primary">Masuk ke Sistem</button>
            </form>
            
            <div class="request-access">
                <p>Belum punya kode akses?</p>
                <button class="btn btn-whatsapp" onclick="showRequestForm()">
                    <i class="bi bi-whatsapp"></i> Request Kode Akses via WhatsApp
                </button>
            </div>
            
            <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                ← Kembali ke Portal Utama
            </button>
            
            <div class="login-info">
                <p>Gunakan kode akses yang telah diberikan untuk mengakses sistem.</p>
            </div>
        </div>
        
        <div class="footer">
            <div>© 2025 Bidang Perbendaharaan BPKAD Kabupaten Mamuju</div>
        </div>
    </div>
    
    <!-- Request Modal -->
    <div class="modal request-modal" id="requestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="bi bi-key"></i> Request Kode Akses</h3>
                <button class="close-modal" onclick="closeRequestModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="request-instruction">
                    <p><strong>Proses setelah request:</strong></p>
                    <ol>
                        <li>Form akan membuka WhatsApp ke admin</li>
                        <li>Anda perlu menekan <strong>SEND</strong> manual di WhatsApp</li>
                        <li>Admin akan membalas via WhatsApp dengan kode akses</li>
                        <li>Gunakan kode tersebut untuk login ke sistem</li>
                    </ol>
                </div>
                
                <form id="requestForm" onsubmit="sendWhatsAppRequest(event)">
                    <div class="form-group">
                        <label for="requestNama">Nama Lengkap *</label>
                        <input type="text" id="requestNama" class="form-control" placeholder="Masukkan nama lengkap" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="requestSKPD">SKPD *</label>
                        <select id="requestSKPD" class="form-control" required>
                            <option value="">Pilih SKPD</option>
                            <option value="DINAS PENDIDIKAN, PEMUDA DAN OLAHRAGA">DINAS PENDIDIKAN, PEMUDA DAN OLAHRAGA</option>
                            <option value="DINAS KESEHATAN">DINAS KESEHATAN</option>
                            <option value="DINAS PEKERJAAN UMUM DAN PENATAAN RUANG">DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</option>
                            <option value="DINAS PERUMAHAN RAKYAT KAWASAN PERMUKIMAN DAN PERTANAHAN">DINAS PERUMAHAN RAKYAT KAWASAN PERMUKIMAN DAN PERTANAHAN</option>
                            <option value="SATUAN POLISI PAMONG PRAJA DAN PEMADAM KEBAKARAN">SATUAN POLISI PAMONG PRAJA DAN PEMADAM KEBAKARAN</option>
                            <option value="BADAN PENANGGULANGAN BENCANA DAERAH">BADAN PENANGGULANGAN BENCANA DAERAH</option>
                            <option value="DINAS SOSIAL">DINAS SOSIAL</option>
                            <option value="DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK">DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK</option>
                            <option value="DINAS KETAHANAN PANGAN">DINAS KETAHANAN PANGAN</option>
                            <option value="DINAS LINGKUNGAN HIDUP DAN KEBERSIHAN">DINAS LINGKUNGAN HIDUP DAN KEBERSIHAN</option>
                            <option value="DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL">DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL</option>
                            <option value="DINAS PEMBERDAYAAN MASYARAKAT DAN DESA">DINAS PEMBERDAYAAN MASYARAKAT DAN DESA</option>
                            <option value="DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA">DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA</option>
                            <option value="DINAS PERHUBUNGAN">DINAS PERHUBUNGAN</option>
                            <option value="DINAS KOMUNIKASI, INFORMATIKA, STATISTIK DAN PERSANDIAN">DINAS KOMUNIKASI, INFORMATIKA, STATISTIK DAN PERSANDIAN</option>
                            <option value="DINAS KOPERASI, USAHA KECIL DAN MENENGAH, DAN PERINDUSTRIAN">DINAS KOPERASI, USAHA KECIL DAN MENENGAH, DAN PERINDUSTRIAN</option>
                            <option value="DINAS PENANAMAN MODAL DAN PELAYANAN TERPADU SATU PINTU">DINAS PENANAMAN MODAL DAN PELAYANAN TERPADU SATU PINTU</option>
                            <option value="DINAS PERPUSTAKAAN DAN KEARSIPAN">DINAS PERPUSTAKAAN DAN KEARSIPAN</option>
                            <option value="DINAS KELAUTAN DAN PERIKANAN">DINAS KELAUTAN DAN PERIKANAN</option>
                            <option value="DINAS PARIWISATA DAN KEBUDAYAAN">DINAS PARIWISATA DAN KEBUDAYAAN</option>
                            <option value="DINAS PERKEBUNAN">DINAS PERKEBUNAN</option>
                            <option value="DINAS TANAMAN PANGAN, HOLTIKULTURA, DAN PETERNAKAN">DINAS TANAMAN PANGAN, HOLTIKULTURA, DAN PETERNAKAN</option>
                            <option value="DINAS PERDAGANGAN">DINAS PERDAGANGAN</option>
                            <option value="DINAS TRANSMIGRASI DAN TENAGA KERJA">DINAS TRANSMIGRASI DAN TENAGA KERJA</option>
                            <option value="SEKRETARIAT DAERAH">SEKRETARIAT DAERAH</option>
                            <option value="SEKRETARIAT DPRD">SEKRETARIAT DPRD</option>
                            <option value="BADAN PERENCANAAN PEMBANGUNAN RISET DAN INOVASI DAERAH">BADAN PERENCANAAN PEMBANGUNAN RISET DAN INOVASI DAERAH</option>
                            <option value="BADAN PENDAPATAN DAERAH">BADAN PENDAPATAN DAERAH</option>
                            <option value="BADAN PENGELOLA KEUANGAN DAN ASET DAERAH">BADAN PENGELOLA KEUANGAN DAN ASET DAERAH</option>
                            <option value="BADAN KEPEGAWAIAN, PENDIDIKAN DAN PELATIHAN">BADAN KEPEGAWAIAN, PENDIDIKAN DAN PELATIHAN</option>
                            <option value="INSPEKTORAT DAERAH">INSPEKTORAT DAERAH</option>
                            <option value="KANTOR KECAMATAN MAMUJU">KANTOR KECAMATAN MAMUJU</option>
                            <option value="KANTOR KECAMATAN SIMBORO">KANTOR KECAMATAN SIMBORO</option>
                            <option value="KANTOR KECAMATAN TAPALANG">KANTOR KECAMATAN TAPALANG</option>
                            <option value="KANTOR KECAMATAN TAPALANG BARAT">KANTOR KECAMATAN TAPALANG BARAT</option>
                            <option value="KANTOR KECAMATAN KALUKKU">KANTOR KECAMATAN KALUKKU</option>
                            <option value="KANTOR KECAMATAN PAPALANG">KANTOR KECAMATAN PAPALANG</option>
                            <option value="KANTOR KECAMATAN SAMPAGA">KANTOR KECAMATAN SAMPAGA</option>
                            <option value="KANTOR KECAMATAN BONEHAU">KANTOR KECAMATAN BONEHAU</option>
                            <option value="KANTOR KECAMATAN KALUMPANG">KANTOR KECAMATAN KALUMPANG</option>
                            <option value="KANTOR KECAMATAN KEPULAUAN BALA-BALAKANG">KANTOR KECAMATAN KEPULAUAN BALA-BALAKANG</option>
                            <option value="KANTOR KECAMATAN TOMMO">KANTOR KECAMATAN TOMMO</option>
                            <option value="BADAN KESATUAN BANGSA DAN POLITIK">BADAN KESATUAN BANGSA DAN POLITIK</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="requestJabatan">Jabatan *</label>
                        <input type="text" id="requestJabatan" class="form-control" placeholder="Contoh: Kepala Bidang, Staff, dll" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="requestHP">Nomor WhatsApp (Opsional)</label>
                        <input type="tel" id="requestHP" class="form-control" placeholder="08xxx" pattern="[0-9]{10,13}">
                        <small style="color: #666;">Untuk konfirmasi lebih cepat</small>
                    </div>
                    
                    <button type="submit" class="btn btn-whatsapp">
                        <i class="bi bi-whatsapp"></i> Buka WhatsApp untuk Kirim Request
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeRequestModal()" style="margin-top: 10px;">
                        Batal
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Screen (hidden by default) -->
    <div class="dashboard-container" id="dashboardScreen" style="display: none;">
        <div class="dashboard-header">
            <div>
                <h1>CERMAT CLOUD</h1>
                <p>Cek dan Rekonsiliasi Manajemen Transaksi Berbasis Cloud</p>
            </div>
            <div class="user-info">
                <h3 id="displayNama">-</h3>
                <p id="displaySKPD">-</p>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div class="dashboard-nav">
            <button class="nav-btn active" onclick="showTab('home')">
                <i class="bi bi-house-door"></i> Beranda
            </button>
            <button class="nav-btn" onclick="showTab('data')" id="dataTabBtn">
                <i class="bi bi-table"></i> Data Transaksi
            </button>
            <button class="nav-btn" onclick="showTab('rekap')">
                <i class="bi bi-bar-chart"></i> Rekap
            </button>
            <button class="nav-btn" onclick="showTab('grafik')">
                <i class="bi bi-graph-up"></i> Grafik
            </button>
            <button class="nav-btn" id="uploadBtn" style="display: none;" onclick="window.open('https://forms.gle/n16ZJUthCrMS41TA8', '_blank')">
                <i class="bi bi-cloud-upload"></i> Input Data Transaksi
            </button>
            <button class="nav-btn" id="verifikasiBtn" style="display: none;" onclick="window.open('https://docs.google.com/spreadsheets/d/1lnN7wFk9_mbRsBHL6QqtvsxDb3neVWUKbCdY47VcjF4/edit?usp=sharing', '_blank')">
                <i class="bi bi-check-circle"></i> Verifikasi Transaksi
            </button>
            <button class="nav-btn" onclick="loadDataFromGoogleSheets(true)">
                <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </button>
        </div>
        
        <div class="dashboard-content">
            <!-- Home Tab -->
            <div id="homeTab" class="tab-content active">
                <div class="welcome-message">
                    <h2>Selamat datang, <span id="welcomeNama">-</span></h2>
                    <p>Anda login sebagai <strong id="welcomeSKPD">-</strong></p>
                </div>
                
                <div class="access-info" id="accessInfo">
                    <strong>Hak Akses:</strong> <span id="hakAkses">-</span>
                </div>
                
                <div id="dataAlert" style="display: none;"></div>
                
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats will be loaded here -->
                </div>
                
                <h3 style="margin: 30px 0 20px 0; color: #1a2980;">Transaksi Terbaru</h3>
                <div class="table-container">
                    <div id="recentTransactions">
                        <!-- Recent transactions will be loaded here -->
                    </div>
                    <button class="card-btn" onclick="showTab('data')" style="margin-top: 20px;">
                        <i class="bi bi-eye"></i> Lihat Semua Data
                    </button>
                </div>
            </div>
            
            <!-- Data Tab -->
            <div id="dataTab" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #1a2980;">Data Transaksi</h2>
                
                <div class="export-buttons">
                    <button class="export-btn export-excel" onclick="exportDataToExcel()">
                        <i class="bi bi-file-earmark-excel"></i> Export ke Excel
                    </button>
                </div>
                
                <div class="filter-section">
                    <div class="filter-group">
                        <input type="text" id="searchInput" class="filter-input" placeholder="Cari SKPD, No SPM, atau Uraian...">
                        <select id="skpdFilter" class="filter-input">
                            <option value="">Semua SKPD</option>
                        </select>
                        <button class="filter-btn" onclick="applyFilters()">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                        <button class="card-btn" onclick="resetFilters()" style="width: auto;">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <div id="allTransactions">
                        <!-- All transactions will be loaded here -->
                    </div>
                    <div class="pagination" id="pagination">
                        <!-- Pagination will be generated here -->
                    </div>
                </div>
            </div>
            
            <!-- Rekap Tab -->
            <div id="rekapTab" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #1a2980;">Rekap Data</h2>
                
                <div class="export-buttons">
                    <button class="export-btn export-excel" onclick="exportRekapToExcel()">
                        <i class="bi bi-file-earmark-excel"></i> Export Rekap ke Excel
                    </button>
                </div>
                
                <div class="table-container">
                    <h3 style="margin-bottom: 20px; color: #1a2980;">Rekap Pencairan per SKPD</h3>
                    <table id="rekapTable">
                        <!-- Rekap table will be loaded here -->
                    </table>
                </div>
                
                <div class="table-container" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px; color: #1a2980;">Realisasi Sumber Dana per SKPD</h3>
                    <div id="sumberDanaPerSKPD">
                        <!-- Sumber dana per SKPD akan dimuat di sini dengan format tabel yang rapi -->
                    </div>
                </div>
                
                <!-- Rekap Realisasi per Sumber Dana Pemda (hanya untuk perbend dan super admin) -->
                <div id="rekapSumberDanaPemda" style="display: none;">
                    <div class="table-container" style="margin-top: 30px;">
                        <h3 style="margin-bottom: 20px; color: #1a2980;">Rekap Realisasi per Sumber Dana Pemda</h3>
                        <div id="rekapSumberDanaContainer">
                            <!-- Rekap sumber dana pemda akan dimuat di sini -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Grafik Tab -->
            <div id="grafikTab" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #1a2980;">Visualisasi Data</h2>
                
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Total Pencairan per SKPD (Top 10)</h3>
                        <canvas id="chartTop10"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Distribusi Sumber Dana</h3>
                        <canvas id="chartSumberDana"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Trend Bulanan Pencairan</h3>
                        <canvas id="chartTrend"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <div>Sistem CERMAT CLOUD - Versi 1.0 | Terakhir diakses: <span id="lastAccess">-</span></div>
        </div>
    </div>
    
    <!-- MODERN DETAIL MODAL -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="bi bi-file-text"></i> Detail Transaksi</h3>
                <button class="close-modal" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modern detail content will be loaded here -->
            </div>
            <div class="modal-footer">
                <div class="transaction-id" id="transactionId"></div>
                <div class="modal-actions">
                    <button class="modal-btn modal-btn-print" onclick="window.print()">
                        <i class="bi bi-printer"></i> Cetak
                    </button>
                    <button class="modal-btn modal-btn-close" onclick="closeModal()">
                        <i class="bi bi-x-lg"></i> Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data SKPD dan kode akses
        const skpdData = [
            { kode: "lenrongji", skpd: "super admin", hakAkses: "semua" },
            { kode: "perbend2026", skpd: "bidang perbendaharaan", hakAkses: "semua" },
            { kode: "diknas2026", skpd: "DINAS PENDIDIKAN, PEMUDA DAN OLAHRAGA", hakAkses: "DINAS PENDIDIKAN, PEMUDA DAN OLAHRAGA" },
            { kode: "dinkes2026", skpd: "DINAS KESEHATAN", hakAkses: "DINAS KESEHATAN" },
            { kode: "pupr2026", skpd: "DINAS PEKERJAAN UMUM DAN PENATAAN RUANG", hakAkses: "DINAS PEKERJAAN UMUM DAN PENATAAN RUANG" },
            { kode: "perkim2026", skpd: "DINAS PERUMAHAN RAKYAT KAWASAN PERMUKIMAN DAN PERTANAHAN", hakAkses: "DINAS PERUMAHAN RAKYAT KAWASAN PERMUKIMAN DAN PERTANAHAN" },
            { kode: "satpolpp2026", skpd: "SATUAN POLISI PAMONG PRAJA DAN PEMADAM KEBAKARAN", hakAkses: "SATUAN POLISI PAMONG PRAJA DAN PEMADAM KEBAKARAN" },
            { kode: "bpbd2026", skpd: "BADAN PENANGGULANGAN BENCANA DAERAH", hakAkses: "BADAN PENANGGULANGAN BENCANA DAERAH" },
            { kode: "dinsos2026", skpd: "DINAS SOSIAL", hakAkses: "DINAS SOSIAL" },
            { kode: "dp3a2026", skpd: "DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK", hakAkses: "DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK" },
            { kode: "ketpang2026", skpd: "DINAS KETAHANAN PANGAN", hakAkses: "DINAS KETAHANAN PANGAN" },
            { kode: "dlhk2026", skpd: "DINAS LINGKUNGAN HIDUP DAN KEBERSIHAN", hakAkses: "DINAS LINGKUNGAN HIDUP DAN KEBERSIHAN" },
            { kode: "dukcapil2026", skpd: "DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL", hakAkses: "DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL" },
            { kode: "dpmd2026", skpd: "DINAS PEMBERDAYAAN MASYARAKAT DAN DESA", hakAkses: "DINAS PEMBERDAYAAN MASYARAKAT DAN DESA" },
            { kode: "dppkb2026", skpd: "DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA", hakAkses: "DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA" },
            { kode: "dishub2026", skpd: "DINAS PERHUBUNGAN", hakAkses: "DINAS PERHUBUNGAN" },
            { kode: "diskominfo2026", skpd: "DINAS KOMUNIKASI, INFORMATIKA, STATISTIK DAN PERSANDIAN", hakAkses: "DINAS KOMUNIKASI, INFORMATIKA, STATISTIK DAN PERSANDIAN" },
            { kode: "diskop2026", skpd: "DINAS KOPERASI, USAHA KECIL DAN MENENGAH, DAN PERINDUSTRIAN", hakAkses: "DINAS KOPERASI, USAHA KECIL DAN MENENGAH, DAN PERINDUSTRIAN" },
            { kode: "dpmptsp2026", skpd: "DINAS PENANAMAN MODAL DAN PELAYANAN TERPADU SATU PINTU", hakAkses: "DINAS PENANAMAN MODAL DAN PELAYANAN TERPADU SATU PINTU" },
            { kode: "perpus2026", skpd: "DINAS PERPUSTAKAAN DAN KEARSIPAN", hakAkses: "DINAS PERPUSTAKAAN DAN KEARSIPAN" },
            { kode: "dkp2026", skpd: "DINAS KELAUTAN DAN PERIKANAN", hakAkses: "DINAS KELAUTAN DAN PERIKANAN" },
            { kode: "dispar2026", skpd: "DINAS PARIWISATA DAN KEBUDAYAAN", hakAkses: "DINAS PARIWISATA DAN KEBUDAYAAN" },
            { kode: "disbun2026", skpd: "DINAS PERKEBUNAN", hakAkses: "DINAS PERKEBUNAN" },
            { kode: "distanak2026", skpd: "DINAS TANAMAN PANGAN, HOLTIKULTURA, DAN PETERNAKAN", hakAkses: "DINAS TANAMAN PANGAN, HOLTIKULTURA, DAN PETERNAKAN" },
            { kode: "disdag2026", skpd: "DINAS PERDAGANGAN", hakAkses: "DINAS PERDAGANGAN" },
            { kode: "disnaker2026", skpd: "DINAS TRANSMIGRASI DAN TENAGA KERJA", hakAkses: "DINAS TRANSMIGRASI DAN TENAGA KERJA" },
            { kode: "setda2026", skpd: "SEKRETARIAT DAERAH", hakAkses: "SEKRETARIAT DAERAH" },
            { kode: "setdprd2026", skpd: "SEKRETARIAT DPRD", hakAkses: "SEKRETARIAT DPRD" },
            { kode: "bapperida2026", skpd: "BADAN PERENCANAAN PEMBANGUNAN RISET DAN INOVASI DAERAH", hakAkses: "BADAN PERENCANAAN PEMBANGUNAN RISET DAN INOVASI DAERAH" },
            { kode: "bapenda2026", skpd: "BADAN PENDAPATAN DAERAH", hakAkses: "BADAN PENDAPATAN DAERAH" },
            { kode: "bpkad2026", skpd: "BADAN PENGELOLA KEUANGAN DAN ASET DAERAH", hakAkses: "BADAN PENGELOLA KEUANGAN DAN ASET DAERAH" },
            { kode: "bkpp2026", skpd: "BADAN KEPEGAWAIAN, PENDIDIKAN DAN PELATIHAN", hakAkses: "BADAN KEPEGAWAIAN, PENDIDIKAN DAN PELATIHAN" },
            { kode: "inspektorat2026", skpd: "INSPEKTORAT DAERAH", hakAkses: "INSPEKTORAT DAERAH" },
            { kode: "kecmamuju2026", skpd: "KANTOR KECAMATAN MAMUJU", hakAkses: "KANTOR KECAMATAN MAMUJU" },
            { kode: "kecsimboro2026", skpd: "KANTOR KECAMATAN SIMBORO", hakAkses: "KANTOR KECAMATAN SIMBORO" },
            { kode: "kectapalang2026", skpd: "KANTOR KECAMATAN TAPALANG", hakAkses: "KANTOR KECAMATAN TAPALANG" },
            { kode: "kectapalbar2026", skpd: "KANTOR KECAMATAN TAPALANG BARAT", hakAkses: "KANTOR KECAMATAN TAPALANG BARAT" },
            { kode: "keckalukku2026", skpd: "KANTOR KECAMATAN KALUKKU", hakAkses: "KANTOR KECAMATAN KALUKKU" },
            { kode: "kecpapalang2026", skpd: "KANTOR KECAMATAN PAPALANG", hakAkses: "KANTOR KECAMATAN PAPALANG" },
            { kode: "kecsampaga2026", skpd: "KANTOR KECAMATAN SAMPAGA", hakAkses: "KANTOR KECAMATAN SAMPAGA" },
            { kode: "kecbonehau2026", skpd: "KANTOR KECAMATAN BONEHAU", hakAkses: "KANTOR KECAMATAN BONEHAU" },
            { kode: "keckalumpang2026", skpd: "KANTOR KECAMATAN KALUMPANG", hakAkses: "KANTOR KECAMATAN KALUMPANG" },
            { kode: "kecbalabalakang2026", skpd: "KANTOR KECAMATAN KEPULAUAN BALA-BALAKANG", hakAkses: "KANTOR KECAMATAN KEPULAUAN BALA-BALAKANG" },
            { kode: "kectommo2026", skpd: "KANTOR KECAMATAN TOMMO", hakAkses: "KANTOR KECAMATAN TOMMO" },
            { kode: "kesbangpol2026", skpd: "BADAN KESATUAN BANGSA DAN POLITIK", hakAkses: "BADAN KESATUAN BANGSA DAN POLITIK" }
        ];

        // Global variables
        let currentUser = null;
        let allTransactions = [];
        let filteredTransactions = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        
        // URL Google Sheets yang sudah diperbarui
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpsOpz8ruUqpJmd57h9_c9OoS6Ucx3EDgz3NDWfD0_oecX7OlGL4zFxtU93AwWCsGe0Ca6bx-KfVj_/pub?output=csv';

        // Check if user is already logged in
        document.addEventListener('DOMContentLoaded', function() {
            const savedUser = localStorage.getItem('cermatCloudUser');
            const savedLoginTime = localStorage.getItem('cermatCloudLoginTime');
            
            if (savedUser) {
                const user = JSON.parse(savedUser);
                showDashboard(user);
                if (savedLoginTime) {
                    document.getElementById('lastAccess').textContent = savedLoginTime;
                }
                loadDataFromGoogleSheets();
            }
        });

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nama = document.getElementById('nama').value.trim();
            const kodeAkses = document.getElementById('kodeAkses').value.trim();
            const errorMessage = document.getElementById('errorMessage');
            
            // Find matching SKPD
            const matchedSKPD = skpdData.find(item => item.kode === kodeAkses);
            
            if (matchedSKPD && nama) {
                // Login successful
                errorMessage.style.display = 'none';
                
                const user = {
                    nama: nama,
                    skpd: matchedSKPD.skpd,
                    hakAkses: matchedSKPD.hakAkses
                };
                
                // Save to localStorage
                localStorage.setItem('cermatCloudUser', JSON.stringify(user));
                
                // Save login time
                const now = new Date();
                const loginTime = now.toLocaleDateString('id-ID', { 
                    weekday: 'long',
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                localStorage.setItem('cermatCloudLoginTime', loginTime);
                
                // Show dashboard
                showDashboard(user);
                document.getElementById('lastAccess').textContent = loginTime;
                
                // Load data from Google Sheets
                loadDataFromGoogleSheets();
            } else {
                // Login failed
                errorMessage.style.display = 'block';
            }
        });

        // Function to show dashboard
        function showDashboard(user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            
            // Update user info
            document.getElementById('displayNama').textContent = user.nama;
            document.getElementById('displaySKPD').textContent = user.skpd;
            document.getElementById('welcomeNama').textContent = user.nama;
            document.getElementById('welcomeSKPD').textContent = user.skpd;
            document.getElementById('hakAkses').textContent = user.hakAkses;
            
            // Show/hide buttons based on hakAkses
            // Hanya super admin dan bidang perbendaharaan yang bisa verifikasi
            if (user.hakAkses === 'semua' && (user.skpd === 'super admin' || user.skpd === 'bidang perbendaharaan')) {
                document.getElementById('verifikasiBtn').style.display = 'block';
                document.getElementById('uploadBtn').style.display = 'none';
                // Tampilkan rekap sumber dana pemda untuk perbend dan super admin
                document.getElementById('rekapSumberDanaPemda').style.display = 'block';
            } else {
                // SKPD biasa hanya bisa input data
                document.getElementById('uploadBtn').style.display = 'block';
                document.getElementById('verifikasiBtn').style.display = 'none';
                document.getElementById('rekapSumberDanaPemda').style.display = 'none';
            }
            
            // Show/hide admin button based on hakAkses
            if (user.hakAkses === 'semua') {
                document.getElementById('accessInfo').style.background = 'linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%)';
                document.getElementById('accessInfo').style.border = '1px solid #7dd3fc';
                document.getElementById('hakAkses').innerHTML = '<strong>SEMUA DATA (Full Access)</strong>';
            }
        }

        // Function to load data from Google Sheets
        async function loadDataFromGoogleSheets(showAlert = false) {
            const loadingHTML = '<div class="loading"><div class="loading-spinner"></div><p>Memuat data dari Google Sheets...</p></div>';
            document.getElementById('recentTransactions').innerHTML = loadingHTML;
            document.getElementById('allTransactions').innerHTML = loadingHTML;
            document.getElementById('statsGrid').innerHTML = loadingHTML;
            document.getElementById('rekapTable').innerHTML = loadingHTML;
            document.getElementById('sumberDanaPerSKPD').innerHTML = loadingHTML;
            document.getElementById('rekapSumberDanaContainer').innerHTML = loadingHTML;
            
            // Show alert jika manual refresh
            if (showAlert) {
                document.getElementById('dataAlert').innerHTML = `
                    <div class="warning-alert">
                        <i class="bi bi-arrow-clockwise"></i>
                        <div>Memperbarui data dari Google Sheets...</div>
                    </div>
                `;
                document.getElementById('dataAlert').style.display = 'block';
            }
            
            try {
                console.log('Mengambil data dari:', GOOGLE_SHEETS_URL);
                
                // Fetch data dengan timeout 10 detik
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'GET',
                    mode: 'cors',
                    signal: controller.signal,
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('Data berhasil diambil, panjang:', csvText.length, 'karakter');
                
                if (csvText.length < 100) {
                    throw new Error('Data terlalu pendek atau kosong');
                }
                
                // Parse CSV dengan metode yang lebih sederhana
                const parsedData = parseSimpleCSV(csvText);
                
                if (parsedData.length === 0) {
                    throw new Error('Tidak ada data yang berhasil diparsing');
                }
                
                console.log('Data berhasil diparsing:', parsedData.length, 'baris');
                
                // Proses data transaksi
                processTransactions(parsedData);
                
                // Update alert
                if (showAlert) {
                    document.getElementById('dataAlert').innerHTML = `
                        <div class="success-alert">
                            <i class="bi bi-check-circle"></i>
                            <div>Data berhasil diperbarui! ${parsedData.length} transaksi ditemukan.</div>
                        </div>
                    `;
                    
                    // Hapus alert setelah 5 detik
                    setTimeout(() => {
                        document.getElementById('dataAlert').style.display = 'none';
                    }, 5000);
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                
                // Tampilkan error ke user
                document.getElementById('dataAlert').innerHTML = `
                    <div class="warning-alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        <div>
                            <strong>Gagal mengambil data dari Google Sheets:</strong><br>
                            ${error.message}<br>
                            <small>Menggunakan data contoh untuk demonstrasi.</small>
                        </div>
                    </div>
                `;
                document.getElementById('dataAlert').style.display = 'block';
                
                // Gunakan data contoh
                useSampleData();
            }
        }

        // Fungsi parsing CSV yang SEDERHANA dan ROBUST
        function parseSimpleCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return [];
            
            // Ambil header (baris pertama)
            const headers = lines[0].split(',').map(h => h.trim());
            
            // Proses data
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                
                // Skip baris kosong
                if (line.trim() === '') continue;
                
                const values = [];
                let currentValue = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '"' && !inQuotes) {
                        inQuotes = true;
                    } else if (char === '"' && inQuotes) {
                        inQuotes = false;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                
                // Tambahkan nilai terakhir
                values.push(currentValue.trim());
                
                // Pastikan jumlah kolom sesuai header
                while (values.length < headers.length) {
                    values.push('');
                }
                
                // Ambil hanya sejumlah header yang ada
                const trimmedValues = values.slice(0, headers.length);
                
                // Buat objek transaksi
                const transaction = {};
                headers.forEach((header, index) => {
                    transaction[header] = trimmedValues[index] || '';
                });
                
                // Convert jumlah ke number
                const jumlahStr = transaction.JUMLAH || '0';
                transaction.JUMLAH_NUM = parseFloat(jumlahStr.replace(/[^0-9.-]+/g, "")) || 0;
                
                // Convert semua sumber dana fields to numbers
                const sumberDanaFields = [
                    'DANA ALOKASI UMUM (DAU) - DAU BEBAS',
                    'DANA ALOKASI UMUM (DAU) - PENDIDIKAN',
                    'DANA ALOKASI UMUM (DAU) - KESEHATAN',
                    'DANA ALOKASI UMUM (DAU) - KELURAHAN',
                    'DANA ALOKASI KHUSUS - DAK FISIK',
                    'DANA ALOKASI KHUSUS - DAK NON FISIK',
                    'DBH PUSAT - SAWIT',
                    'DBH PUSAT - DBH Pusat',
                    'DBH PROVINSI - Pajak Rokok',
                    'DBH PROVINSI - DBH Provinsi',
                    'PENDAPATAN ASLI DAERAH - Pajak Penerangan Jalan',
                    'PENDAPATAN ASLI DAERAH - Opsen PKB',
                    'PENDAPATAN ASLI DAERAH - Pajak Air Bawah Tanah',
                    'PENDAPATAN ASLI DAERAH - Pelayanan Kesehatan',
                    'PENDAPATAN ASLI DAERAH - PAD',
                    'DANA DESA - DANA DESA',
                    'SiLPA 2025 - SiLPA 2025'
                ];
                
                sumberDanaFields.forEach(field => {
                    if (transaction[field] !== undefined) {
                        const value = transaction[field] || '0';
                        transaction[field + '_NUM'] = parseFloat(value.replace(/[^0-9.-]+/g, "")) || 0;
                    }
                });
                
                data.push(transaction);
            }
            
            return data;
        }

        // Fungsi untuk memproses data transaksi
        function processTransactions(transactions) {
            // Simpan data global
            allTransactions = transactions;
            
            // Sort by timestamp descending (terbaru dulu)
            allTransactions.sort((a, b) => {
                const dateA = parseSimpleDate(a.Timestamp || '');
                const dateB = parseSimpleDate(b.Timestamp || '');
                return dateB - dateA;
            });
            
            // Apply user filter jika bukan admin
            if (currentUser && currentUser.hakAkses !== 'semua') {
                allTransactions = allTransactions.filter(t => 
                    t.SKPD && t.SKPD.toLowerCase().includes(currentUser.skpd.toLowerCase())
                );
            }
            
            filteredTransactions = [...allTransactions];
            
            // Update semua tampilan
            displayRecentTransactions();
            displayAllTransactions();
            populateSKPDFilter();
            updateDashboardStats();
            displayRekap();
            displayRekapSumberDanaPerSKPD();
            if (currentUser && (currentUser.skpd === 'super admin' || currentUser.skpd === 'bidang perbendaharaan')) {
                displayRekapSumberDanaPemda();
            }
            displayCharts();
        }

        // Fungsi parsing tanggal yang lebih sederhana
        function parseSimpleDate(dateString) {
            if (!dateString || dateString.trim() === '') return new Date(0);
            
            // Coba berbagai format tanggal
            const formats = [
                /(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/, // DD/MM/YYYY HH:MM:SS
                /(\d{2})\/(\d{2})\/(\d{4})/, // DD/MM/YYYY
                /(\d{4})-(\d{2})-(\d{2})/, // YYYY-MM-DD
            ];
            
            for (const format of formats) {
                const match = dateString.match(format);
                if (match) {
                    if (match[4]) { // Ada jam
                        return new Date(
                            parseInt(match[3]),
                            parseInt(match[2]) - 1,
                            parseInt(match[1]),
                            parseInt(match[4]),
                            parseInt(match[5]),
                            parseInt(match[6])
                        );
                    } else { // Hanya tanggal
                        return new Date(
                            parseInt(match[3]),
                            parseInt(match[2]) - 1,
                            parseInt(match[1])
                        );
                    }
                }
            }
            
            return new Date(); // Fallback ke tanggal sekarang
        }

        // Fungsi untuk menggunakan data contoh
        function useSampleData() {
            // Data contoh dari spreadsheet
            const sampleTransactions = [
                {
                    Timestamp: "23/01/2026 21:28:14",
                    "JENIS DOKUMEN": "LS",
                    "TANGGAL SPM": "31/12/2025",
                    SKPD: "DINAS PEKERJAAN UMUM DAN PENATAAN RUANG",
                    "NOMOR SPM": "76.02/03.0/000310/LS/1.03.0.00.0.00.01.0000/PPR2/12/2025",
                    "URAIAN SPM": "PERBAIKAN PIPA TRANSMISI DAN DISTRIBUSI SPAM SO'DO DAN KATAPI PASCA BENCANA KAB. MAMUJU. (BKK)",
                    "DANA ALOKASI UMUM (DAU) - DAU BEBAS": "0",
                    "DANA ALOKASI UMUM (DAU) - PENDIDIKAN": "100000000",
                    "DANA ALOKASI UMUM (DAU) - KESEHATAN": "100000000",
                    "DANA ALOKASI UMUM (DAU) - KELURAHAN": "100000000",
                    "DANA ALOKASI KHUSUS - DAK FISIK": "100000000",
                    "DANA ALOKASI KHUSUS - DAK NON FISIK": "100000000",
                    "DBH PUSAT - SAWIT": "0",
                    "DBH PUSAT - DBH Pusat": "0",
                    "DBH PROVINSI - Pajak Rokok": "0",
                    "DBH PROVINSI - DBH Provinsi": "0",
                    "PENDAPATAN ASLI DAERAH - Pajak Penerangan Jalan": "0",
                    "PENDAPATAN ASLI DAERAH - Opsen PKB": "2912447",
                    "PENDAPATAN ASLI DAERAH - Pajak Air Bawah Tanah": "0",
                    "PENDAPATAN ASLI DAERAH - Pelayanan Kesehatan": "0",
                    "PENDAPATAN ASLI DAERAH - PAD": "0",
                    "DANA DESA - DANA DESA": "0",
                    "SiLPA 2025 - SiLPA 2025": "0",
                    JUMLAH: "502912447",
                    "NOMOR SP2D": "76.02/04.0/000310/LS/1.03.0.00.0.00.01.0000/PPR2/12/2025",
                    "NAMA OPERATOR": "EDHA",
                    KETERANGAN: "TELAH CAIR TANGGAL 31 DESEMBER 2025",
                    JUMLAH_NUM: 502912447
                },
                {
                    Timestamp: "22/01/2026 14:30:00",
                    "JENIS DOKUMEN": "GU",
                    "TANGGAL SPM": "30/12/2025",
                    SKPD: "DINAS KESEHATAN",
                    "NOMOR SPM": "76.02/03.0/000311/GU/1.02.0.00.0.00.01.0000/DINKES/12/2025",
                    "URAIAN SPM": "PEMBELIAN ALAT KESEHATAN RUMAH SAKIT",
                    "DANA ALOKASI UMUM (DAU) - DAU BEBAS": "50000000",
                    "DANA ALOKASI UMUM (DAU) - PENDIDIKAN": "0",
                    "DANA ALOKASI UMUM (DAU) - KESEHATAN": "0",
                    "DANA ALOKASI UMUM (DAU) - KELURAHAN": "0",
                    "DANA ALOKASI KHUSUS - DAK FISIK": "0",
                    "DANA ALOKASI KHUSUS - DAK NON FISIK": "0",
                    "DBH PUSAT - SAWIT": "0",
                    "DBH PUSAT - DBH Pusat": "0",
                    "DBH PROVINSI - Pajak Rokok": "0",
                    "DBH PROVINSI - DBH Provinsi": "0",
                    "PENDAPATAN ASLI DAERAH - Pajak Penerangan Jalan": "1500000",
                    "PENDAPATAN ASLI DAERAH - Opsen PKB": "0",
                    "PENDAPATAN ASLI DAERAH - Pajak Air Bawah Tanah": "0",
                    "PENDAPATAN ASLI DAERAH - Pelayanan Kesehatan": "0",
                    "PENDAPATAN ASLI DAERAH - PAD": "0",
                    "DANA DESA - DANA DESA": "0",
                    "SiLPA 2025 - SiLPA 2025": "0",
                    JUMLAH: "51500000",
                    "NOMOR SP2D": "76.02/04.0/000311/GU/1.02.0.00.0.00.01.0000/DINKES/12/2025",
                    "NAMA OPERATOR": "BUDI",
                    KETERANGAN: "SUDAH DIVERIFIKASI",
                    JUMLAH_NUM: 51500000
                },
                {
                    Timestamp: "21/01/2026 10:15:00",
                    "JENIS DOKUMEN": "LS",
                    "TANGGAL SPM": "29/12/2025",
                    SKPD: "DINAS PENDIDIKAN, PEMUDA DAN OLAHRAGA",
                    "NOMOR SPM": "76.02/03.0/000312/LS/1.01.0.00.0.00.01.0000/DIKNAS/12/2025",
                    "URAIAN SPM": "PENYEDIAAN BUKU PELAJARAN SEKOLAH",
                    "DANA ALOKASI UMUM (DAU) - DAU BEBAS": "0",
                    "DANA ALOKASI UMUM (DAU) - PENDIDIKAN": "75000000",
                    "DANA ALOKASI UMUM (DAU) - KESEHATAN": "0",
                    "DANA ALOKASI UMUM (DAU) - KELURAHAN": "0",
                    "DANA ALOKASI KHUSUS - DAK FISIK": "50000000",
                    "DANA ALOKASI KHUSUS - DAK NON FISIK": "0",
                    "DBH PUSAT - SAWIT": "0",
                    "DBH PUSAT - DBH Pusat": "0",
                    "DBH PROVINSI - Pajak Rokok": "0",
                    "DBH PROVINSI - DBH Provinsi": "0",
                    "PENDAPATAN ASLI DAERAH - Pajak Penerangan Jalan": "0",
                    "PENDAPATAN ASLI DAERAH - Opsen PKB": "0",
                    "PENDAPATAN ASLI DAERAH - Pajak Air Bawah Tanah": "0",
                    "PENDAPATAN ASLI DAERAH - Pelayanan Kesehatan": "0",
                    "PENDAPATAN ASLI DAERAH - PAD": "0",
                    "DANA DESA - DANA DESA": "0",
                    "SiLPA 2025 - SiLPA 2025": "0",
                    JUMLAH: "125000000",
                    "NOMOR SP2D": "76.02/04.0/000312/LS/1.01.0.00.0.00.01.0000/DIKNAS/12/2025",
                    "NAMA OPERATOR": "SITI",
                    KETERANGAN: "MENUNGGU VERIFIKASI",
                    JUMLAH_NUM: 125000000
                }
            ];
            
            // Tambahkan data contoh untuk testing
            const skpds = [
                "DINAS PENDIDIKAN, PEMUDA DAN OLAHRAGA",
                "DINAS KESEHATAN",
                "DINAS PEKERJAAN UMUM DAN PENATAAN RUANG",
                "SATUAN POLISI PAMONG PRAJA DAN PEMADAM KEBAKARAN",
                "DINAS SOSIAL",
                "DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK",
                "DINAS KETAHANAN PANGAN",
                "DINAS LINGKUNGAN HIDUP DAN KEBERSIHAN"
            ];
            
            for (let i = 0; i < 20; i++) {
                const jenis = ["LS", "GU", "TU"][i % 3];
                const skpd = skpds[i % skpds.length];
                const amount = 25000000 + (i * 5000000);
                const day = 20 - Math.floor(i / 3);
                
                sampleTransactions.push({
                    Timestamp: `${day}/01/2026 ${10 + (i%8)}:${(i*3)%60}:00`,
                    "JENIS DOKUMEN": jenis,
                    "TANGGAL SPM": `${25 - i}/12/2025`,
                    SKPD: skpd,
                    "NOMOR SPM": `76.02/03.0/000${400 + i}/${jenis}/1.0${(i%10)+1}.0.00.0.00.01.0000/${skpd.substring(0,6).toUpperCase()}/12/2025`,
                    "URAIAN SPM": `Transaksi ${jenis} ${i + 1} untuk ${skpd}`,
                    "DANA ALOKASI UMUM (DAU) - DAU BEBAS": (i % 2 === 0 ? amount * 0.3 : 0).toString(),
                    "DANA ALOKASI UMUM (DAU) - PENDIDIKAN": (i % 3 === 0 ? amount * 0.4 : 0).toString(),
                    "DANA ALOKASI KHUSUS - DAK FISIK": (i % 4 === 0 ? amount * 0.5 : 0).toString(),
                    "PENDAPATAN ASLI DAERAH - PAD": (i % 5 === 0 ? amount * 0.2 : 0).toString(),
                    JUMLAH: amount.toString(),
                    "NOMOR SP2D": `76.02/04.0/000${400 + i}/${jenis}/1.0${(i%10)+1}.0.00.0.00.01.0000/${skpd.substring(0,6).toUpperCase()}/12/2025`,
                    "NAMA OPERATOR": ["BUDI", "SITI", "AGUS", "DWI", "RINA", "ANDI", "FERDI", "MIRA", "JOKO", "EDHA"][i % 10],
                    KETERANGAN: i % 3 === 0 ? "SUDAH CAIR" : i % 3 === 1 ? "MENUNGGU VERIFIKASI" : "PROSES PENCATATAN",
                    JUMLAH_NUM: amount
                });
            }
            
            processTransactions(sampleTransactions);
        }

        // Format currency (tanpa Rp)
        function formatCurrency(amount) {
            if (isNaN(amount)) amount = 0;
            return new Intl.NumberFormat('id-ID', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Display recent transactions
        function displayRecentTransactions() {
            const recent = allTransactions.slice(0, 10);
            
            if (recent.length === 0) {
                document.getElementById('recentTransactions').innerHTML = 
                    '<div class="loading"><p>Tidak ada data transaksi</p></div>';
                return;
            }
            
            let html = '<table>';
            html += '<thead><tr><th>No</th><th>SKPD</th><th>No SPM</th><th>Jumlah</th><th>Tanggal SPM</th><th>Status</th><th>Aksi</th></tr></thead><tbody>';
            
            recent.forEach((transaction, index) => {
                const status = transaction.KETERANGAN || 'Tidak ada keterangan';
                const statusClass = status.includes('CAIR') || status.includes('SUDAH') || status.includes('DIVALIDASI') || status.includes('DICEK') || status.includes('DISETUJUI') || status.includes('TEREALISASI') ? 'badge-success' : 
                                  status.includes('MENUNGGU') || status.includes('PROSES') ? 'badge-warning' : 'badge-info';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${transaction.SKPD || '-'}</td>
                        <td>${transaction['NOMOR SPM'] || '-'}</td>
                        <td>${formatCurrency(transaction.JUMLAH_NUM)}</td>
                        <td>${transaction['TANGGAL SPM'] || '-'}</td>
                        <td><span class="badge ${statusClass}">${status.substring(0, 20)}${status.length > 20 ? '...' : ''}</span></td>
                        <td><button class="view-detail-btn" onclick="showDetail(${index})">Detail</button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('recentTransactions').innerHTML = html;
        }

        // Display all transactions with pagination
        function displayAllTransactions() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            if (pageTransactions.length === 0) {
                document.getElementById('allTransactions').innerHTML = 
                    '<div class="loading"><p>Tidak ada data yang sesuai dengan filter</p></div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            let html = '<table>';
            html += '<thead><tr><th>No</th><th>Timestamp</th><th>SKPD</th><th>No SPM</th><th>Jumlah</th><th>No SP2D</th><th>Operator</th><th>Status</th><th>Aksi</th></tr></thead><tbody>';
            
            pageTransactions.forEach((transaction, index) => {
                const globalIndex = allTransactions.findIndex(t => t === transaction);
                const status = transaction.KETERANGAN || 'Tidak ada keterangan';
                const statusClass = status.includes('CAIR') || status.includes('SUDAH') || status.includes('DIVALIDASI') || status.includes('DICEK') || status.includes('DISETUJUI') || status.includes('TEREALISASI') ? 'badge-success' : 
                                  status.includes('MENUNGGU') || status.includes('PROSES') ? 'badge-warning' : 'badge-info';
                
                html += `
                    <tr>
                        <td>${startIndex + index + 1}</td>
                        <td>${transaction.Timestamp || '-'}</td>
                        <td>${transaction.SKPD || '-'}</td>
                        <td>${transaction['NOMOR SPM'] || '-'}</td>
                        <td>${formatCurrency(transaction.JUMLAH_NUM)}</td>
                        <td>${transaction['NOMOR SP2D'] || '-'}</td>
                        <td>${transaction['NAMA OPERATOR'] || '-'}</td>
                        <td><span class="badge ${statusClass}">${status.substring(0, 15)}${status.length > 15 ? '...' : ''}</span></td>
                        <td><button class="view-detail-btn" onclick="showDetail(${globalIndex})">Detail</button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('allTransactions').innerHTML = html;
            
            // Generate pagination
            generatePagination();
        }

        // Generate pagination controls
        function generatePagination() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            let html = '';
            
            if (totalPages > 1) {
                html += '<button class="page-btn" onclick="changePage(1)" ' + (currentPage === 1 ? 'disabled' : '') + '>«</button>';
                html += '<button class="page-btn" onclick="changePage(' + (currentPage - 1) + ')" ' + (currentPage === 1 ? 'disabled' : '') + '>‹</button>';
                
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                    }
                }
                
                html += '<button class="page-btn" onclick="changePage(' + (currentPage + 1) + ')" ' + (currentPage === totalPages ? 'disabled' : '') + '>›</button>';
                html += '<button class="page-btn" onclick="changePage(' + totalPages + ')" ' + (currentPage === totalPages ? 'disabled' : '') + '>»</button>';
            }
            
            document.getElementById('pagination').innerHTML = html;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            displayAllTransactions();
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const skpdFilter = document.getElementById('skpdFilter').value;
            
            filteredTransactions = allTransactions.filter(transaction => {
                const matchesSearch = !searchTerm || 
                    (transaction.SKPD && transaction.SKPD.toLowerCase().includes(searchTerm)) ||
                    (transaction['NOMOR SPM'] && transaction['NOMOR SPM'].toLowerCase().includes(searchTerm)) ||
                    (transaction['URAIAN SPM'] && transaction['URAIAN SPM'].toLowerCase().includes(searchTerm));
                
                const matchesSKPD = !skpdFilter || 
                    (transaction.SKPD && transaction.SKPD === skpdFilter);
                
                return matchesSearch && matchesSKPD;
            });
            
            currentPage = 1;
            displayAllTransactions();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('skpdFilter').value = '';
            filteredTransactions = [...allTransactions];
            currentPage = 1;
            displayAllTransactions();
        }

        // Populate SKPD filter dropdown
        function populateSKPDFilter() {
            const skpdFilter = document.getElementById('skpdFilter');
            const skpds = [...new Set(allTransactions.map(t => t.SKPD).filter(s => s))].sort();
            
            // Clear existing options except the first one
            while (skpdFilter.options.length > 1) {
                skpdFilter.remove(1);
            }
            
            skpds.forEach(skpd => {
                const option = document.createElement('option');
                option.value = skpd;
                option.textContent = skpd;
                skpdFilter.appendChild(option);
            });
        }

        // MODERN SHOW TRANSACTION DETAIL
        function showDetail(index) {
            const transaction = allTransactions[index];
            
            let html = `
                <div class="modal-grid">
                    <div class="modal-section">
                        <div class="modal-section-header">
                            <i class="bi bi-building"></i>
                            <h4>Informasi Umum</h4>
                        </div>
                        <div class="modal-section-content">
                            <div class="detail-group">
                                <div class="detail-label">SKPD</div>
                                <div class="detail-value">${transaction.SKPD || '-'}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Jenis Dokumen</div>
                                <div class="detail-value">${transaction['JENIS DOKUMEN'] || '-'}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Tanggal SPM</div>
                                <div class="detail-value">${transaction['TANGGAL SPM'] || '-'}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">No SPM</div>
                                <div class="detail-value">${transaction['NOMOR SPM'] || '-'}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Uraian SPM</div>
                                <div class="detail-value">${transaction['URAIAN SPM'] || '-'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="modal-section-header">
                            <i class="bi bi-cash-stack"></i>
                            <h4>Informasi Keuangan</h4>
                        </div>
                        <div class="modal-section-content">
                            <div class="detail-group">
                                <div class="detail-label">Jumlah Transaksi</div>
                                <div class="detail-value amount">${formatCurrency(transaction.JUMLAH_NUM)}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">No SP2D</div>
                                <div class="detail-value">${transaction['NOMOR SP2D'] || '-'}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Operator</div>
                                <div class="detail-value">${transaction['NAMA OPERATOR'] || '-'}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Timestamp</div>
                                <div class="detail-value">${transaction.Timestamp || '-'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-section" style="grid-column: span 2;">
                        <div class="modal-section-header">
                            <i class="bi bi-activity"></i>
                            <h4>Status Transaksi</h4>
                        </div>
                        <div class="modal-section-content">
                            <div class="detail-group">
                                <div class="detail-label">Keterangan / Status</div>
            `;
            
            const status = transaction.KETERANGAN || 'Tidak ada keterangan';
            let statusClass = 'detail-value';
            if (status.includes('CAIR') || status.includes('SUDAH') || status.includes('DIVALIDASI') || status.includes('DICEK') || status.includes('DISETUJUI') || status.includes('TEREALISASI')) {
                statusClass += ' status-success';
            } else if (status.includes('MENUNGGU') || status.includes('PROSES')) {
                statusClass += ' status-warning';
            } else {
                statusClass += ' status-info';
            }
            
            html += `<div class="${statusClass}">${status}</div>`;
            html += `</div></div></div>`;
            
            // Sumber Dana Section
            html += `
                <div class="modal-section" style="grid-column: span 2;">
                    <div class="modal-section-header">
                        <i class="bi bi-piggy-bank"></i>
                        <h4>Sumber Dana</h4>
                    </div>
                    <div class="modal-section-content">
                        <div class="sumber-dana-grid">
            `;
            
            const sumberDanaFields = [
                { field: 'DANA ALOKASI UMUM (DAU) - DAU BEBAS', name: 'DAU Bebas' },
                { field: 'DANA ALOKASI UMUM (DAU) - PENDIDIKAN', name: 'DAU Pendidikan' },
                { field: 'DANA ALOKASI UMUM (DAU) - KESEHATAN', name: 'DAU Kesehatan' },
                { field: 'DANA ALOKASI UMUM (DAU) - KELURAHAN', name: 'DAU Kelurahan' },
                { field: 'DANA ALOKASI KHUSUS - DAK FISIK', name: 'DAK Fisik' },
                { field: 'DANA ALOKASI KHUSUS - DAK NON FISIK', name: 'DAK Non Fisik' },
                { field: 'DBH PUSAT - SAWIT', name: 'DBH Sawit' },
                { field: 'DBH PUSAT - DBH Pusat', name: 'DBH Pusat' },
                { field: 'DBH PROVINSI - Pajak Rokok', name: 'DBH Pajak Rokok' },
                { field: 'DBH PROVINSI - DBH Provinsi', name: 'DBH Provinsi' },
                { field: 'PENDAPATAN ASLI DAERAH - Pajak Penerangan Jalan', name: 'PAD Penerangan Jalan' },
                { field: 'PENDAPATAN ASLI DAERAH - Opsen PKB', name: 'PAD Opsen PKB' },
                { field: 'PENDAPATAN ASLI DAERAH - Pajak Air Bawah Tanah', name: 'PAD Air Bawah Tanah' },
                { field: 'PENDAPATAN ASLI DAERAH - Pelayanan Kesehatan', name: 'PAD Pelayanan Kesehatan' },
                { field: 'PENDAPATAN ASLI DAERAH - PAD', name: 'PAD Lainnya' },
                { field: 'DANA DESA - DANA DESA', name: 'Dana Desa' },
                { field: 'SiLPA 2025 - SiLPA 2025', name: 'SiLPA 2025' }
            ];
            
            let hasSumberDana = false;
            sumberDanaFields.forEach(item => {
                const value = transaction[item.field + '_NUM'] || 0;
                if (value > 0) {
                    hasSumberDana = true;
                    html += `
                        <div class="sumber-dana-card">
                            <div class="sumber-dana-label">${item.name}</div>
                            <div class="sumber-dana-value">${formatCurrency(value)}</div>
                        </div>
                    `;
                }
            });
            
            if (!hasSumberDana) {
                html += `
                    <div class="sumber-dana-card" style="grid-column: span 2; text-align: center;">
                        <div class="sumber-dana-label">Tidak ada data sumber dana</div>
                        <div class="sumber-dana-value">-</div>
                    </div>
                `;
            }
            
            html += `</div></div></div>`;
            html += `</div>`;
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('transactionId').textContent = `ID Transaksi: ${transaction['NOMOR SPM'] || 'N/A'}`;
            document.getElementById('detailModal').style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            const stats = calculateStatistics();
            let html = '';
            
            html += `
                <div class="stat-card">
                    <div class="stat-icon">📊</div>
                    <div class="stat-title">Total Transaksi</div>
                    <div class="stat-value">${stats.totalTransactions}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">💰</div>
                    <div class="stat-title">Total Nilai</div>
                    <div class="stat-value">${formatCurrency(stats.totalValue)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">👥</div>
                    <div class="stat-title">Jumlah SKPD</div>
                    <div class="stat-value">${stats.totalSKPD}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⭐</div>
                    <div class="stat-title">SKPD Teraktif</div>
                    <div class="stat-value" style="font-size: 16px;">${stats.mostActiveSKPD}</div>
                </div>
            `;
            
            document.getElementById('statsGrid').innerHTML = html;
        }

        // Calculate statistics
        function calculateStatistics() {
            const skpds = [...new Set(allTransactions.map(t => t.SKPD).filter(s => s))];
            
            // Find SKPD with most transactions
            let skpdCounts = {};
            let skpdValues = {};
            
            allTransactions.forEach(t => {
                if (t.SKPD) {
                    skpdCounts[t.SKPD] = (skpdCounts[t.SKPD] || 0) + 1;
                    skpdValues[t.SKPD] = (skpdValues[t.SKPD] || 0) + t.JUMLAH_NUM;
                }
            });
            
            let mostActiveSKPD = '-';
            let maxCount = 0;
            let highestValueSKPD = '-';
            let maxValue = 0;
            
            for (const [skpd, count] of Object.entries(skpdCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    mostActiveSKPD = skpd;
                }
                
                if (skpdValues[skpd] > maxValue) {
                    maxValue = skpdValues[skpd];
                    highestValueSKPD = skpd;
                }
            }
            
            const stats = {
                totalTransactions: allTransactions.length,
                totalValue: allTransactions.reduce((sum, t) => sum + t.JUMLAH_NUM, 0),
                totalSKPD: skpds.length,
                mostActiveSKPD: mostActiveSKPD.substring(0, 20) + (mostActiveSKPD.length > 20 ? '...' : ''),
                highestValueSKPD: highestValueSKPD.substring(0, 20) + (highestValueSKPD.length > 20 ? '...' : '')
            };
            
            return stats;
        }

        // Display rekap data
        function displayRekap() {
            const rekap = calculateRekap();
            
            // Rekap per SKPD
            let rekapHtml = '<table><thead><tr><th>No</th><th>SKPD</th><th>Jumlah Transaksi</th><th>Total Nilai</th><th>Rata-rata per Transaksi</th></tr></thead><tbody>';
            
            rekap.perSKPD.forEach((item, index) => {
                rekapHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.skpd}</td>
                        <td>${item.count}</td>
                        <td>${formatCurrency(item.total)}</td>
                        <td>${formatCurrency(item.average)}</td>
                    </tr>
                `;
            });
            
            rekapHtml += '</tbody></table>';
            document.getElementById('rekapTable').innerHTML = rekapHtml;
        }

        // Display rekap sumber dana per SKPD dengan format tabel yang rapi
        function displayRekapSumberDanaPerSKPD() {
            const rekap = calculateRekapSumberDanaPerSKPD();
            
            if (rekap.length === 0) {
                document.getElementById('sumberDanaPerSKPD').innerHTML = 
                    '<div class="loading"><p>Tidak ada data realisasi sumber dana per SKPD</p></div>';
                return;
            }
            
            let html = '';
            
            // Ringkasan statistik
            const totalSKPD = rekap.length;
            let totalTransaksi = 0;
            let totalRealisasi = 0;
            
            rekap.forEach(skpdData => {
                skpdData.sumberDana.forEach(item => {
                    totalTransaksi += item.jumlahTransaksi;
                    totalRealisasi += item.total;
                });
            });
            
            html += `
                <div class="sumber-dana-summary">
                    <div class="summary-item">
                        <div class="summary-label">Jumlah SKPD</div>
                        <div class="summary-value">${totalSKPD}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Transaksi</div>
                        <div class="summary-value">${totalTransaksi}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Realisasi</div>
                        <div class="summary-value">${formatCurrency(totalRealisasi)}</div>
                    </div>
                </div>
            `;
            
            // Tabel untuk setiap SKPD
            rekap.forEach((skpdData, skpdIndex) => {
                html += `
                    <div class="sumber-dana-table-container" style="margin-top: ${skpdIndex === 0 ? '10px' : '30px'}">
                        <h4 style="color: #1a2980; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #1a2980;">
                            ${skpdData.skpd}
                        </h4>
                        <table class="sumber-dana-table">
                            <thead>
                                <tr>
                                    <th>Sumber Dana</th>
                                    <th>Jumlah Transaksi</th>
                                    <th>Total Realisasi</th>
                                    <th>Persentase</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                const totalSKPDValue = skpdData.sumberDana.reduce((sum, item) => sum + item.total, 0);
                
                skpdData.sumberDana.forEach(item => {
                    const persentase = totalSKPDValue > 0 ? ((item.total / totalSKPDValue) * 100).toFixed(2) : 0;
                    html += `
                        <tr>
                            <td>${item.nama}</td>
                            <td>${item.jumlahTransaksi}</td>
                            <td>${formatCurrency(item.total)}</td>
                            <td>${persentase}%</td>
                        </tr>
                    `;
                });
                
                // Total per SKPD
                html += `
                            </tbody>
                            <tfoot>
                                <tr style="background: #f8f9fa; font-weight: 600;">
                                    <td>Total ${skpdData.skpd}</td>
                                    <td>${skpdData.sumberDana.reduce((sum, item) => sum + item.jumlahTransaksi, 0)}</td>
                                    <td>${formatCurrency(totalSKPDValue)}</td>
                                    <td>100%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
            });
            
            document.getElementById('sumberDanaPerSKPD').innerHTML = html;
        }

        // Display rekap sumber dana pemda (hanya untuk perbend dan super admin)
        function displayRekapSumberDanaPemda() {
            const rekap = calculateRekapSumberDanaPemda();
            
            let html = '<table><thead><tr><th>Sumber Dana</th><th>Jumlah Transaksi</th><th>Total Realisasi</th><th>Persentase</th></tr></thead><tbody>';
            
            const totalAll = rekap.reduce((sum, item) => sum + item.total, 0);
            
            rekap.forEach(item => {
                const persentase = totalAll > 0 ? ((item.total / totalAll) * 100).toFixed(2) : 0;
                html += `
                    <tr>
                        <td>${item.nama}</td>
                        <td>${item.jumlahTransaksi}</td>
                        <td>${formatCurrency(item.total)}</td>
                        <td>${persentase}%</td>
                    </tr>
                `;
            });
            
            // Total
            html += `
                <tr style="background: #f8f9fa; font-weight: 600;">
                    <td>TOTAL</td>
                    <td>${rekap.reduce((sum, item) => sum + item.jumlahTransaksi, 0)}</td>
                    <td>${formatCurrency(totalAll)}</td>
                    <td>100%</td>
                </tr>
            `;
            
            html += `</tbody></table>`;
            document.getElementById('rekapSumberDanaContainer').innerHTML = html;
        }

        // Calculate rekap data
        function calculateRekap() {
            const rekap = {
                perSKPD: []
            };
            
            // Group by SKPD
            const skpdGroups = {};
            allTransactions.forEach(transaction => {
                const skpd = transaction.SKPD || 'Unknown';
                if (!skpdGroups[skpd]) {
                    skpdGroups[skpd] = {
                        count: 0,
                        total: 0,
                        transactions: []
                    };
                }
                skpdGroups[skpd].count++;
                skpdGroups[skpd].total += transaction.JUMLAH_NUM;
                skpdGroups[skpd].transactions.push(transaction);
            });
            
            // Convert to array and sort by total descending
            rekap.perSKPD = Object.keys(skpdGroups).map(skpd => ({
                skpd: skpd,
                count: skpdGroups[skpd].count,
                total: skpdGroups[skpd].total,
                average: skpdGroups[skpd].total / skpdGroups[skpd].count
            })).sort((a, b) => b.total - a.total);
            
            return rekap;
        }

        // Calculate rekap sumber dana per SKPD
        function calculateRekapSumberDanaPerSKPD() {
            const result = [];
            
            // Group transactions by SKPD
            const skpdGroups = {};
            allTransactions.forEach(transaction => {
                const skpd = transaction.SKPD || 'Unknown';
                if (!skpdGroups[skpd]) {
                    skpdGroups[skpd] = [];
                }
                skpdGroups[skpd].push(transaction);
            });
            
            // Process each SKPD
            Object.keys(skpdGroups).forEach(skpd => {
                const transactions = skpdGroups[skpd];
                const sumberDanaMap = {};
                
                // Define sumber dana fields
                const sumberDanaFields = [
                    { field: 'DANA ALOKASI UMUM (DAU) - DAU BEBAS', name: 'DAU Bebas' },
                    { field: 'DANA ALOKASI UMUM (DAU) - PENDIDIKAN', name: 'DAU Pendidikan' },
                    { field: 'DANA ALOKASI UMUM (DAU) - KESEHATAN', name: 'DAU Kesehatan' },
                    { field: 'DANA ALOKASI UMUM (DAU) - KELURAHAN', name: 'DAU Kelurahan' },
                    { field: 'DANA ALOKASI KHUSUS - DAK FISIK', name: 'DAK Fisik' },
                    { field: 'DANA ALOKASI KHUSUS - DAK NON FISIK', name: 'DAK Non Fisik' },
                    { field: 'DBH PUSAT - SAWIT', name: 'DBH Sawit' },
                    { field: 'DBH PUSAT - DBH Pusat', name: 'DBH Pusat' },
                    { field: 'DBH PROVINSI - Pajak Rokok', name: 'DBH Pajak Rokok' },
                    { field: 'DBH PROVINSI - DBH Provinsi', name: 'DBH Provinsi' },
                    { field: 'PENDAPATAN ASLI DAERAH - Pajak Penerangan Jalan', name: 'PAD Penerangan Jalan' },
                    { field: 'PENDAPATAN ASLI DAERAH - Opsen PKB', name: 'PAD Opsen PKB' },
                    { field: 'PENDAPATAN ASLI DAERAH - Pajak Air Bawah Tanah', name: 'PAD Air Bawah Tanah' },
                    { field: 'PENDAPATAN ASLI DAERAH - Pelayanan Kesehatan', name: 'PAD Pelayanan Kesehatan' },
                    { field: 'PENDAPATAN ASLI DAERAH - PAD', name: 'PAD Lainnya' },
                    { field: 'DANA DESA - DANA DESA', name: 'Dana Desa' },
                    { field: 'SiLPA 2025 - SiLPA 2025', name: 'SiLPA 2025' }
                ];
                
                // Initialize sumber dana map
                sumberDanaFields.forEach(item => {
                    sumberDanaMap[item.field] = {
                        nama: item.name,
                        jumlahTransaksi: 0,
                        total: 0
                    };
                });
                
                // Calculate for each transaction
                transactions.forEach(transaction => {
                    sumberDanaFields.forEach(item => {
                        const value = transaction[item.field + '_NUM'] || 0;
                        if (value > 0) {
                            sumberDanaMap[item.field].jumlahTransaksi++;
                            sumberDanaMap[item.field].total += value;
                        }
                    });
                });
                
                // Filter hanya yang ada realisasinya
                const sumberDanaList = [];
                sumberDanaFields.forEach(item => {
                    if (sumberDanaMap[item.field].jumlahTransaksi > 0) {
                        sumberDanaList.push(sumberDanaMap[item.field]);
                    }
                });
                
                // Sort by total descending
                sumberDanaList.sort((a, b) => b.total - a.total);
                
                // Add to result if there's any sumber dana
                if (sumberDanaList.length > 0) {
                    result.push({
                        skpd: skpd,
                        sumberDana: sumberDanaList
                    });
                }
            });
            
            // Sort SKPD by name
            result.sort((a, b) => a.skpd.localeCompare(b.skpd));
            
            return result;
        }

        // Calculate rekap sumber dana pemda
        function calculateRekapSumberDanaPemda() {
            const result = [];
            
            // Define sumber dana fields
            const sumberDanaFields = [
                { field: 'DANA ALOKASI UMUM (DAU) - DAU BEBAS', name: 'DAU Bebas' },
                { field: 'DANA ALOKASI UMUM (DAU) - PENDIDIKAN', name: 'DAU Pendidikan' },
                { field: 'DANA ALOKASI UMUM (DAU) - KESEHATAN', name: 'DAU Kesehatan' },
                { field: 'DANA ALOKASI UMUM (DAU) - KELURAHAN', name: 'DAU Kelurahan' },
                { field: 'DANA ALOKASI KHUSUS - DAK FISIK', name: 'DAK Fisik' },
                { field: 'DANA ALOKASI KHUSUS - DAK NON FISIK', name: 'DAK Non Fisik' },
                { field: 'DBH PUSAT - SAWIT', name: 'DBH Sawit' },
                { field: 'DBH PUSAT - DBH Pusat', name: 'DBH Pusat' },
                { field: 'DBH PROVINSI - Pajak Rokok', name: 'DBH Pajak Rokok' },
                { field: 'DBH PROVINSI - DBH Provinsi', name: 'DBH Provinsi' },
                { field: 'PENDAPATAN ASLI DAERAH - Pajak Penerangan Jalan', name: 'PAD Penerangan Jalan' },
                { field: 'PENDAPATAN ASLI DAERAH - Opsen PKB', name: 'PAD Opsen PKB' },
                { field: 'PENDAPATAN ASLI DAERAH - Pajak Air Bawah Tanah', name: 'PAD Air Bawah Tanah' },
                { field: 'PENDAPATAN ASLI DAERAH - Pelayanan Kesehatan', name: 'PAD Pelayanan Kesehatan' },
                { field: 'PENDAPATAN ASLI DAERAH - PAD', name: 'PAD Lainnya' },
                { field: 'DANA DESA - DANA DESA', name: 'Dana Desa' },
                { field: 'SiLPA 2025 - SiLPA 2025', name: 'SiLPA 2025' }
            ];
            
            // Initialize result map
            const sumberDanaMap = {};
            sumberDanaFields.forEach(item => {
                sumberDanaMap[item.field] = {
                    nama: item.name,
                    jumlahTransaksi: 0,
                    total: 0
                };
            });
            
            // Calculate totals
            allTransactions.forEach(transaction => {
                sumberDanaFields.forEach(item => {
                    const value = transaction[item.field + '_NUM'] || 0;
                    if (value > 0) {
                        sumberDanaMap[item.field].jumlahTransaksi++;
                        sumberDanaMap[item.field].total += value;
                    }
                });
            });
            
            // Convert to array and filter only those with transactions
            sumberDanaFields.forEach(item => {
                if (sumberDanaMap[item.field].jumlahTransaksi > 0) {
                    result.push(sumberDanaMap[item.field]);
                }
            });
            
            // Sort by total descending
            result.sort((a, b) => b.total - a.total);
            
            return result;
        }

        // Display charts
        function displayCharts() {
            const rekap = calculateRekap();
            
            // Chart 1: Top 10 SKPD by total value
            const top10 = rekap.perSKPD.slice(0, 10);
            const ctx1 = document.getElementById('chartTop10');
            
            if (window.top10Chart) {
                window.top10Chart.destroy();
            }
            
            // Buat chart hanya jika ada data
            if (top10.length > 0) {
                window.top10Chart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: top10.map(item => {
                            const skpd = item.skpd;
                            return skpd.substring(0, 15) + (skpd.length > 15 ? '...' : '');
                        }),
                        datasets: [{
                            label: 'Total Pencairan',
                            data: top10.map(item => item.total),
                            backgroundColor: 'rgba(26, 41, 128, 0.7)',
                            borderColor: 'rgba(26, 41, 128, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        if (value >= 1000000) {
                                            return (value / 1000000).toFixed(1) + 'M';
                                        } else if (value >= 1000) {
                                            return (value / 1000).toFixed(0) + 'K';
                                        }
                                        return value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return formatCurrency(context.raw);
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                ctx1.parentElement.innerHTML = '<p>Tidak ada data untuk ditampilkan</p>';
            }
            
            // Chart 2: Sumber Dana Distribution
            const totalBySource = calculateTotalBySource();
            const ctx2 = document.getElementById('chartSumberDana');
            
            if (window.sumberDanaChart) {
                window.sumberDanaChart.destroy();
            }
            
            if (totalBySource.length > 0) {
                window.sumberDanaChart = new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: totalBySource.map(item => item.source),
                        datasets: [{
                            data: totalBySource.map(item => item.total),
                            backgroundColor: [
                                'rgba(26, 41, 128, 0.7)',
                                'rgba(38, 208, 206, 0.7)',
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${formatCurrency(context.raw)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                ctx2.parentElement.innerHTML = '<p>Tidak ada data sumber dana</p>';
            }
            
            // Chart 3: Monthly Trend
            const monthlyData = calculateMonthlyTrend();
            const ctx3 = document.getElementById('chartTrend');
            
            if (window.trendChart) {
                window.trendChart.destroy();
            }
            
            if (monthlyData.length > 0) {
                window.trendChart = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: monthlyData.map(item => item.month),
                        datasets: [{
                            label: 'Total Pencairan',
                            data: monthlyData.map(item => item.total),
                            borderColor: 'rgba(26, 41, 128, 1)',
                            backgroundColor: 'rgba(26, 41, 128, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        if (value >= 1000000) {
                                            return (value / 1000000).toFixed(1) + 'M';
                                        } else if (value >= 1000) {
                                            return (value / 1000).toFixed(0) + 'K';
                                        }
                                        return value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return formatCurrency(context.raw);
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                ctx3.parentElement.innerHTML = '<p>Tidak ada data trend bulanan</p>';
            }
        }

        // Calculate total by source
        function calculateTotalBySource() {
            const sources = [
                { field: 'DANA ALOKASI UMUM (DAU) - DAU BEBAS', name: 'DAU Bebas' },
                { field: 'DANA ALOKASI KHUSUS - DAK FISIK', name: 'DAK Fisik' },
                { field: 'DANA ALOKASI KHUSUS - DAK NON FISIK', name: 'DAK Non Fisik' },
                { field: 'DBH PUSAT - DBH Pusat', name: 'DBH Pusat' },
                { field: 'PENDAPATAN ASLI DAERAH - PAD', name: 'PAD' },
                { field: 'DANA DESA - DANA DESA', name: 'Dana Desa' },
                { field: 'SiLPA 2025 - SiLPA 2025', name: 'SiLPA 2025' }
            ];
            
            return sources.map(source => ({
                source: source.name,
                total: allTransactions.reduce((sum, t) => sum + (t[source.field + '_NUM'] || 0), 0)
            })).filter(item => item.total > 0);
        }

        // Calculate monthly trend
        function calculateMonthlyTrend() {
            const monthlyData = {};
            
            allTransactions.forEach(transaction => {
                const date = parseSimpleDate(transaction.Timestamp);
                if (isNaN(date.getTime())) return;
                
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('id-ID', { month: 'short', year: 'numeric' });
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        month: monthName,
                        total: 0
                    };
                }
                
                monthlyData[monthKey].total += transaction.JUMLAH_NUM;
            });
            
            // Convert to array and sort by date
            return Object.values(monthlyData)
                .sort((a, b) => {
                    const dateA = new Date(a.month.split(' ')[1], getMonthNumber(a.month.split(' ')[0]));
                    const dateB = new Date(b.month.split(' ')[1], getMonthNumber(b.month.split(' ')[0]));
                    return dateA - dateB;
                });
        }

        function getMonthNumber(monthName) {
            const months = {
                'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'Mei': 4, 'Jun': 5,
                'Jul': 6, 'Agu': 7, 'Sep': 8, 'Okt': 9, 'Nov': 10, 'Des': 11
            };
            return months[monthName] || 0;
        }

        // Export data to Excel
        function exportDataToExcel() {
            if (filteredTransactions.length === 0) {
                alert('Tidak ada data untuk diexport');
                return;
            }
            
            // Prepare data for export
            const exportData = filteredTransactions.map((transaction, index) => {
                return {
                    'No': index + 1,
                    'Timestamp': transaction.Timestamp || '',
                    'SKPD': transaction.SKPD || '',
                    'Jenis Dokumen': transaction['JENIS DOKUMEN'] || '',
                    'Tanggal SPM': transaction['TANGGAL SPM'] || '',
                    'No SPM': transaction['NOMOR SPM'] || '',
                    'Uraian SPM': transaction['URAIAN SPM'] || '',
                    'Jumlah': transaction.JUMLAH_NUM || 0,
                    'No SP2D': transaction['NOMOR SP2D'] || '',
                    'Nama Operator': transaction['NAMA OPERATOR'] || '',
                    'Keterangan': transaction.KETERANGAN || ''
                };
            });
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data Transaksi');
            
            // Generate file name
            const fileName = `Data_Transaksi_CERMAT_${new Date().toISOString().slice(0, 10)}.xlsx`;
            
            // Export to file
            XLSX.writeFile(wb, fileName);
        }

        // Export rekap to Excel
        function exportRekapToExcel() {
            // Prepare rekap data
            const rekapSKPD = calculateRekap();
            const rekapSumberDana = calculateRekapSumberDanaPerSKPD();
            const rekapSumberDanaPemda = currentUser && (currentUser.skpd === 'super admin' || currentUser.skpd === 'bidang perbendaharaan') 
                ? calculateRekapSumberDanaPemda() 
                : [];
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Rekap per SKPD
            const ws1Data = [
                ['REKAP PENCARIAN PER SKPD'],
                ['No', 'SKPD', 'Jumlah Transaksi', 'Total Nilai', 'Rata-rata per Transaksi']
            ];
            
            rekapSKPD.perSKPD.forEach((item, index) => {
                ws1Data.push([
                    index + 1,
                    item.skpd,
                    item.count,
                    item.total,
                    item.average
                ]);
            });
            
            const ws1 = XLSX.utils.aoa_to_sheet(ws1Data);
            
            // Sheet 2: Realisasi Sumber Dana per SKPD
            const ws2Data = [
                ['REALISASI SUMBER DANA PER SKPD']
            ];
            
            rekapSumberDana.forEach(skpdData => {
                ws2Data.push(['']); // Blank row
                ws2Data.push([skpdData.skpd]);
                ws2Data.push(['Sumber Dana', 'Jumlah Transaksi', 'Jumlah Realisasi']);
                
                skpdData.sumberDana.forEach(item => {
                    ws2Data.push([
                        item.nama,
                        item.jumlahTransaksi,
                        item.total
                    ]);
                });
            });
            
            const ws2 = XLSX.utils.aoa_to_sheet(ws2Data);
            
            // Sheet 3: Rekap Sumber Dana Pemda (jika ada)
            if (rekapSumberDanaPemda.length > 0) {
                const ws3Data = [
                    ['REKAP REALISASI PER SUMBER DANA PEMDA'],
                    ['Sumber Dana', 'Jumlah Transaksi', 'Total Realisasi', 'Persentase']
                ];
                
                const totalAll = rekapSumberDanaPemda.reduce((sum, item) => sum + item.total, 0);
                
                rekapSumberDanaPemda.forEach(item => {
                    const persentase = totalAll > 0 ? ((item.total / totalAll) * 100).toFixed(2) : 0;
                    ws3Data.push([
                        item.nama,
                        item.jumlahTransaksi,
                        item.total,
                        persentase + '%'
                    ]);
                });
                
                const ws3 = XLSX.utils.aoa_to_sheet(ws3Data);
                XLSX.utils.book_append_sheet(wb, ws3, 'Rekap Sumber Dana');
            }
            
            // Add sheets to workbook
            XLSX.utils.book_append_sheet(wb, ws1, 'Rekap SKPD');
            XLSX.utils.book_append_sheet(wb, ws2, 'Realisasi per SKPD');
            
            // Generate file name
            const fileName = `Rekap_CERMAT_${new Date().toISOString().slice(0, 10)}.xlsx`;
            
            // Export to file
            XLSX.writeFile(wb, fileName);
        }

        // Function untuk modal request
        function showRequestForm() {
            document.getElementById('requestModal').style.display = 'flex';
            // Reset form request
            document.getElementById('requestForm').reset();
        }

        function closeRequestModal() {
            document.getElementById('requestModal').style.display = 'none';
        }

        // Function untuk kirim WhatsApp
        function sendWhatsAppRequest(event) {
            event.preventDefault();
            
            // Ambil nilai form
            const nama = document.getElementById('requestNama').value.trim();
            const skpd = document.getElementById('requestSKPD').value;
            const jabatan = document.getElementById('requestJabatan').value.trim();
            const hp = document.getElementById('requestHP').value.trim();
            
            // Validasi input
            if (!nama || !skpd || !jabatan) {
                alert('Mohon lengkapi semua field yang wajib diisi!');
                return;
            }
            
            // Format pesan sesuai template Anda
            let pesan = `Assalamualaikum wr wb\n\n`;
            pesan += `Saya *${nama}*\n`;
            pesan += `Dari SKPD: *${skpd}*\n`;
            pesan += `Jabatan: *${jabatan}*\n`;
            if (hp) {
                pesan += `No. HP: *${hp}*\n`;
            }
            pesan += `\nMohon untuk diberikan kode akses CERMAT CLOUD.`;
            
            // Encode pesan untuk URL
            const pesanEncoded = encodeURIComponent(pesan);
            
            // Nomor WhatsApp Anda
            const nomorWA = '085756047187';
            
            // Buat URL WhatsApp
            const waURL = `https://wa.me/${nomorWA}?text=${pesanEncoded}`;
            
            // Buka di tab baru
            window.open(waURL, '_blank');
            
            // Tampilkan konfirmasi dan tutup modal
            alert('WhatsApp akan terbuka. Silakan tekan SEND untuk mengirim permintaan Anda.\n\nAdmin akan membalas kode akses via WhatsApp.');
            closeRequestModal();
        }

        // Tab navigation
        function showTab(tabName) {
            // Update active button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show active tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Refresh data if needed
            if (tabName === 'rekap') {
                displayRekap();
                displayRekapSumberDanaPerSKPD();
                if (currentUser && (currentUser.skpd === 'super admin' || currentUser.skpd === 'bidang perbendaharaan')) {
                    displayRekapSumberDanaPemda();
                }
            } else if (tabName === 'grafik') {
                displayCharts();
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('cermatCloudUser');
            localStorage.removeItem('cermatCloudLoginTime');
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            
            // Clear form
            document.getElementById('loginForm').reset();
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            const requestModal = document.getElementById('requestModal');
            
            if (event.target === modal) {
                closeModal();
            }
            if (event.target === requestModal) {
                closeRequestModal();
            }
        };
    </script>
</body>
</html>
